---
title: "Participant Characteristics, Age related Trends in Performance, and other behavioral measures"
author: Ashley C. Parr
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: pdf_document
---

#GO 

```{r, include=FALSE}
# 
if(!is.null(dev.list())) dev.off()# Clear plots
cat("\014") # Clear console
rm(list=ls())# Clean workspace
library(purrr)
library(tvem)
library(scipub)
library(rmarkdown)
library(tinytex)
library(Rmisc)
library(dbplyr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(LNCDR)
library(lme4)
library(car)
library(mgcv)
library(readr)
library(RColorBrewer)
library(gridExtra)
library(survey)
library(ggpubr)
library(plotrix)
library(ggeffects)
library(margins)
library(emmeans)
library(multcomp)
library(stringr)
# 
# library(rmarkdown)
# library(tinytex)
# library(dplyr)
# library(tidyr)
# library(ggplot2)
# library(LNCDR)
# library(mgcv)
# library(readr)
# library(RColorBrewer)
# library(ggpubr)
# library(plotrix)
# library(ggeffects)
knitr::opts_chunk$set(out.width="50%", out.height="50%", warning = FALSE, 
                      fig.pos = 'H', dev = 'png', dpi=150)

library(showtext)
font_add("Arial", "/Users/ashley/Fonts/Arial.ttf")  # Use the actual file path
showtext_auto()


```      



# Housekeeping
## Bring in Relevant Files, Merge, & Clean   
```{r, echo=FALSE}

All_Sites_Iron <- "/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/ALL_SITES_IRON_CLEANED_y8.csv"
All_Sites_Iron <- read.csv(All_Sites_Iron)
 

All_Sites_Iron$roi[All_Sites_Iron$roi=="striatum"] <- "BG"
All_Sites_Iron$roi[All_Sites_Iron$roi=="pallidum"] <- "Pallidum"
All_Sites_Iron$roi[All_Sites_Iron$roi=="caudate"] <- "Caudate"
All_Sites_Iron$roi[All_Sites_Iron$roi=="nacc"] <- "NAcc"
All_Sites_Iron$roi[All_Sites_Iron$roi=="putamen"] <- "Putamen"

#Keep only what you need: 
All_Sites_Iron <- dplyr::select(All_Sites_Iron, subject, visit, roi, site, sex, 
                                tat2.combat, tat2.combat_z)
# List of columns to factorize
columns_to_factorize <- c("subject","sex","site","roi",
                          "visit") 
# Factorize columns
for (col in columns_to_factorize) {
  All_Sites_Iron[[col]] <- factor(All_Sites_Iron[[col]])
} 
 

Long_UPPS <- "/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/LONG_UPPS_y8_newnicotine_08042025.RData"
Long_UPPS1 <- load(Long_UPPS) 


Long_UPPS <- Long_UPPS %>% filter(Subscale!="Total" & oSubscale!="Total")
Long_UPPS$Subscale <- droplevels(Long_UPPS$Subscale)
Long_UPPS$oSubscale <- droplevels(Long_UPPS$oSubscale)


# ALL_SITES_SUBSTANCE_CLEANED_y8_newnicotine_08042025.csv
All_Sites_Substance <- "/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/ALL_SITES_SUBSTANCE_CLEANED_y8_newnicotine_08042025.RData"
All_Sites_Substance1 <- load(All_Sites_Substance)

#Keep only what you need
All_Sites_Substance <- dplyr::select(All_Sites_Substance, subject, visit, site, sex, 
                                visit_age, raceeth_recode, income_recode, age_at_baseline, 
                                contains("first"), contains("upps"),contains("past_30days"))


Long_Substance <- "/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/LONG_SUBSTANCE_y8_newnicotine_08042025.RData"
Long_Substance1 <- load(Long_Substance)
# # #Get rid of 'all' since using probabilistic score 
Long_Substance <- Long_Substance %>% filter(Substance!="All" & Substance !="All Mean")
# # Long_Substance <- Long_Substance %>% filter(Substance!="All Mean" & oSubstance!="All Mean")
# # 
Long_Substance$Substance <- droplevels(Long_Substance$Substance)
Long_Substance$oSubstance <- droplevels(Long_Substance$oSubstance)
Long_Substance <- dplyr::select(Long_Substance, -Category2, -Usetype2,-Category, -Usetype)


Anti_Saccade <- "/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/All_Anti_2023.csv"
Anti_Saccade <- read.csv(Anti_Saccade)


#Bring in Model Outputs 
All_Models_past30prob_logp1 <- "/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Model Outputs 2023/All_Models_past30prob_logp1.RData"
All_Models_past30prob_logp1 <- load(All_Models_past30prob_logp1)
All_Models_past30prob_logp1 <- mod_classes_all
All_Models_past30prob_logp1 <- All_Models_past30prob_logp1 %>%
  rename_with(~ ifelse(.x == "subject", .x, paste0(.x, "past30_Allprob_logp1")))

#Low is reference group - so low, adol, early inc, late inc. 
All_Models_past30prob_logp1$oGMM_4_past30_allprob <- ordered(All_Models_past30prob_logp1$all_gmm_4c_classpast30_Allprob_logp1,
                                                  levels = c("1","4","3","2"))
# 

All_Models_past30prob_logp1$oClass4_renamed <-All_Models_past30prob_logp1$oGMM_4_past30_allprob
# 
All_Models_past30prob_logp1$oClass4_renamed <- revalue(All_Models_past30prob_logp1$oClass4_renamed, c("1" = "Low", "2" = "Late Increase", "3" = "Early Increase",
                                    "4" = "Adolescent"))
#New because all the colors are bananas 
All_Models_past30prob_logp1$oClass4_renamed <- ordered(All_Models_past30prob_logp1$oClass4_renamed, levels = 
                                                         c("Adolescent","Early Increase","Late Increase","Low"))

All_Models_past30prob_logp1 <- dplyr::select(All_Models_past30prob_logp1, subject,  all_gmm_4c_classpast30_Allprob_logp1, oClass4_renamed)
all_mod_outputs <- All_Models_past30prob_logp1


#Factorize subject, visit, site, sex, etc. 
# This is not in long format - this also has UPPS in it (not long)
All_SU_Mod <- merge(all_mod_outputs, All_Sites_Substance, by = "subject")
All_SU_Mod$subject <- as.factor(All_SU_Mod$subject)

# Mod outputs and SU vars long 
All_SU_Mod_Long <- merge(all_mod_outputs, Long_Substance, by = "subject")
All_SU_Mod_Long$subject <- as.factor(All_SU_Mod_Long$subject)

# Merge if you want also long versions of UPPS, AS, ETC. 
All_UPPS_Mod_Long <- merge(All_SU_Mod, Long_UPPS, by = c("subject", "visit","visit_age","sex"))


#Just mod outputs and iron (and relevant covariates) 
temp <- dplyr::select(All_Sites_Substance, subject, visit, raceeth_recode, income_recode)
All_Sites_Iron$subject <- as.factor(All_Sites_Iron$subject)
All_Sites_Iron$visit <- as.factor(All_Sites_Iron$visit)
All_Sites_Iron <- merge(temp, All_Sites_Iron, by = c("subject","visit"))
All_Iron_Mod <- merge(all_mod_outputs, All_Sites_Iron, by = "subject")

#Mod outputs, Iron, SU - Iron in long format with SU data - All Iron MOd is iron in long format just iwth model outputs 
All_Iron_SU_Mod <- merge(All_SU_Mod, All_Sites_Iron, by = c("subject","visit","raceeth_recode",
                                                                   "income_recode",
                                                                   "site","sex"))


#Get rid of bad anti-saccade data 
Anti_Saccade$subject <- as.numeric(gsub("S","",Anti_Saccade$subject))
Anti_Saccade$subject <- factor(Anti_Saccade$subject)
Anti_Saccade$corrat[Anti_Saccade$corrat==0] <- NA
Anti_Saccade$corlat[Anti_Saccade$corrat==0] <- NA
Anti_Saccade$corsd[Anti_Saccade$corrat==0] <- NA

#Stick a threshold on that they have to have greater than 25 viable trials 
Anti_Saccade <- Anti_Saccade %>% filter(total_combo_trackcor>25 & corrat>.40)
Anti_Saccade$corrat <- Anti_Saccade$corrat*100
Anti_Saccade <- dplyr::select(Anti_Saccade, subject, visit, cogRewType, corrat)
Anti_Saccade <- Anti_Saccade %>% filter(!is.na(cogRewType))
All_AS_Mod <- merge(All_SU_Mod, Anti_Saccade, by = c("subject","visit"),all.y=T)
All_AS_Mod <- All_AS_Mod[!is.na(All_AS_Mod$cogRewType),]  
All_AS_Mod$cogRewType <- factor(All_AS_Mod$cogRewType)

# Make a mean score across antisaccade trial types
 
Anti_Saccade <- Anti_Saccade %>%
  group_by(subject, visit) %>%
  filter(cogRewType %in% c("rew", "neu")) %>%
  dplyr::summarise(
    corrat = mean(corrat, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(cogRewType = "main") %>%
  bind_rows(Anti_Saccade)
Anti_Saccade$oCogRewType <- ordered(Anti_Saccade$cogRewType, levels = c("main","rew","neu"))
All_AS_Mod2 <- merge(All_SU_Mod, Anti_Saccade, by = c("subject","visit"),all.y=T)
All_AS_Mod2 <- All_AS_Mod2[!is.na(All_AS_Mod2$cogRewType),]  

``` 

## Calculate Summary Stats: Mean, Peak ages, Peak SU, UPPS, Anti, Iron, ETC. Across Trajectory Groups
```{r, echo=FALSE, fig.align = "center"}

#Get rid of unlikely 'first age' values 
All_SU_Mod$first_any_drug_age[All_SU_Mod$first_any_drug_age>40 | All_SU_Mod$first_any_drug_age<=5] <- NA
All_SU_Mod_Long$Age_of_first_use[All_SU_Mod_Long$Age_of_first_use>40 | All_SU_Mod_Long$Age_of_first_use<=5] <- NA

All_SU_Mod_Long <- All_SU_Mod_Long %>%
  group_by(subject, oClass4_renamed,Substance) %>%
  dplyr::mutate(
    valid_scores = !is.na(past_30) & past_30!=0, # because artificially picking young peak ages for those who report '0's across all visits
        peak_age_SU = if(any(valid_scores)) visit_age[which.max(ifelse(valid_scores, past_30, -Inf))] else NA_real_,
    peak_SU = if(any(valid_scores)) max(past_30, na.rm = TRUE) else NA_real_   
  ) %>%
  dplyr::select(-valid_scores)

subscale_summary <- All_SU_Mod_Long %>%
  group_by(oClass4_renamed,Substance) %>%
  reframe(
    # Mean and SD of all scores for this subscale
    mean_SU = mean(past_30[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    sd_SU = std.error(past_30[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    mean_onset_age = mean(Age_of_first_use[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    SD_onset_age = std.error(Age_of_first_use[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    mean_onset_age2 = mean(Age_of_first_use,na.rm=TRUE),
    sd_onset_age2 = std.error(Age_of_first_use,na.rm=TRUE),
    # Mean of peak scores across subjects
    mean_peak_SU = mean(peak_SU, na.rm = TRUE),
    sd_peak_SU = std.error(peak_SU, na.rm = TRUE),
    # Mean age at which peak occurs
    mean_peak_age_SU = mean(peak_age_SU, na.rm = TRUE),
    SD_peak_age_SU = std.error(peak_age_SU, na.rm = TRUE),
    # Additional useful stats
    n_subjects = n_distinct(subject),
    n_valid_peaks = sum(!is.na(peak_SU)),
    .groups = "drop"
  )


custom_order <- c("All Prob", "Alcohol", "Binge", "Cannabis", "Nicotine")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
subscale_summary <- subscale_summary %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  mutate(Substance = factor(Substance, levels = custom_order)) %>%
  arrange(oClass4_renamed) %>%
  arrange(Substance)

# subscale_summary[] <- lapply(subscale_summary, function(x) if (is.numeric(x)) round(x, 2) else x)

write.csv(subscale_summary, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Summary_Table_Across_Substances_TrajectoryGroups_withZero.csv', row.names = FALSE)

#Get stats for UPPS, AS, Iron

All_UPPS_Mod_Long <- All_UPPS_Mod_Long %>%
  group_by(subject, oClass4_renamed,oSubscale) %>%
  dplyr::mutate(
    valid_scores = !is.na(Score),
    peak_age_UPPS = if(any(valid_scores)) visit_age[which.max(ifelse(valid_scores, Score, -Inf))] else NA_real_,
    peak_UPPS = if(any(valid_scores)) max(Score, na.rm = TRUE) else NA_real_  # Changed this line!
  ) %>%
  dplyr::select(-valid_scores)


subscale_summary_upps <- All_UPPS_Mod_Long %>%
  group_by(oClass4_renamed,oSubscale) %>%
  reframe(
    # Mean and SD of all scores for this subscale
    mean_UPPS = mean(Score[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    sd_UPPS = std.error(Score[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    # Mean of peak scores across subjects
    mean_peak_UPPS = mean(peak_UPPS, na.rm = TRUE),
    sd_peak_UPPS = std.error(peak_UPPS, na.rm = TRUE),
    # Mean age at which peak occurs
    mean_peak_age_UPPS = mean(peak_age_UPPS, na.rm = TRUE),
    SD_peak_age_UPPS = std.error(peak_age_UPPS, na.rm = TRUE),
    # Additional useful stats
    n_subjects = n_distinct(subject),
    n_valid_peaks = sum(!is.na(peak_UPPS)),
    .groups = "drop"
  )


custom_order <- c("Mean", "Neg Urg", "Perseverance", "Pos Urg", "Premeditation", "Sensation Seeking")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
subscale_summary_upps <- subscale_summary_upps %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  mutate(oSubscale = factor(oSubscale, levels = custom_order)) %>%
  arrange(oClass4_renamed) %>%
  arrange(oSubscale)

# subscale_summary_upps[] <- lapply(subscale_summary_upps, function(x) if (is.numeric(x)) round(x, 2) else x)

write.csv(subscale_summary_upps, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Summary_Table_Across_UPPSSubscales_TrajectoryGroups.csv', row.names = FALSE)


#Iron

All_Iron_SU_Mod <- All_Iron_SU_Mod %>%
  group_by(subject, oClass4_renamed,roi) %>%
  dplyr::mutate(
    valid_scores = !is.na(tat2.combat),
    peak_age_Iron = if(any(valid_scores)) visit_age[which.min(ifelse(valid_scores, tat2.combat, -Inf))] else NA_real_,
    peak_Iron = if(any(valid_scores)) min(tat2.combat, na.rm = TRUE) else NA_real_  # Changed this line!

  ) %>%
  dplyr::select(-valid_scores)


subscale_summary_iron <- All_Iron_SU_Mod %>%

  group_by(oClass4_renamed,roi) %>%
  reframe(
    # Mean and SD of all scores for this subscale
    mean_Iron = mean(tat2.combat[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    sd_Iron = std.error(tat2.combat[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    # Mean of peak scores across subjects
    mean_peak_Iron = mean(peak_Iron, na.rm = TRUE),
    sd_peak_Iron = std.error(peak_Iron, na.rm = TRUE),
    # Mean age at which peak occurs
    mean_peak_age_Iron = mean(peak_age_Iron, na.rm = TRUE),
    SD_peak_age_Iron = std.error(peak_age_Iron, na.rm = TRUE),
    # Additional useful stats
    n_subjects = n_distinct(subject),
    n_valid_peaks = sum(!is.na(peak_Iron)),
    .groups = "drop"
  )

custom_order <- c("BG", "Caudate", "NAcc", "Pallidum", "Putamen")

custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
subscale_summary_iron <- subscale_summary_iron %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  mutate(roi = factor(roi, levels = custom_order)) %>%
  arrange(oClass4_renamed) %>%
  arrange(roi)

# subscale_summary_iron[] <- lapply(subscale_summary_iron, function(x) if (is.numeric(x)) round(x, 5) else x)

write.csv(subscale_summary_iron, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Summary_Table_Across_IronROIs_TrajectoryGroups.csv', row.names = FALSE)

# AS

All_AS_Mod2 <- All_AS_Mod2 %>%
  group_by(subject, oClass4_renamed,cogRewType) %>%
  dplyr::mutate(
    valid_scores = !is.na(corrat),
    peak_age_AS = if(any(valid_scores)) visit_age[which.max(ifelse(valid_scores, corrat, -Inf))] else NA_real_,
    peak_AS = if(any(valid_scores)) max(corrat, na.rm = TRUE) else NA_real_  # Changed this line!

  ) %>%
  dplyr::select(-valid_scores)

subscale_summary_AS_1 <- All_AS_Mod2 %>%
  group_by(oClass4_renamed,cogRewType) %>%
  reframe(
    # Mean and SD of all scores for this subscale
    mean_AS = mean(corrat[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    sd_AS = std.error(corrat[oClass4_renamed == cur_group()$oClass4_renamed], na.rm = TRUE),
    # Mean of peak scores across subjects
    mean_peak_AS = mean(peak_AS, na.rm = TRUE),
    sd_peak_AS = std.error(peak_AS, na.rm = TRUE),
    # Mean age at which peak occurs
    mean_peak_age_AS = mean(peak_age_AS, na.rm = TRUE),
    SD_peak_age_AS = std.error(peak_age_AS, na.rm = TRUE),
    # Additional useful stats
    n_subjects = n_distinct(subject),
    n_valid_peaks = sum(!is.na(peak_AS)),
    .groups = "drop"
  )

custom_order <- c("main","rew","neu")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
subscale_summary_AS_1 <- subscale_summary_AS_1 %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  mutate(cogRewType = factor(cogRewType, levels = custom_order)) %>%
  arrange(oClass4_renamed) %>%
  arrange(cogRewType)

# subscale_summary_AS_1[] <- lapply(subscale_summary_AS_1, function(x) if (is.numeric(x)) round(x, 2) else x)

write.csv(subscale_summary_AS_1, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Summary_Table_Across_ASTrialTypes_TrajectoryGroups.csv', row.names = FALSE)


``` 

## Clean Environment 
```{r, echo = FALSE, fig.align='center'}

rm(list=ls()[! ls() %in% c("All_SU_Mod","All_SU_Mod_Long","All_Iron_Mod",
                           "All_Iron_SU_Mod", "All_AS_Mod","All_AS_Mod2", "All_Models_past30prob_logp1",
                           "All_UPPS_Mod_Long","All_UPPS_Mod_Long2", "peak_ages","peakdens.peak_age",
                           "Long_Substance_grmeans","peakdens.first_age","peakdens.reg_age",
                           "peakdens.peak_age_AS_1","peakdens.peak_age_upps",
                           "peakdens.peak_age_iron","Risk_Facs_All","Clinical_All",
                           "subscale_summary", "subscale_summary_AS_1","subscale_summary_AS", "Long_means_all_SES",
                           "subscale_summary_upps", "subscale_summary_iron")])

``` 

## Set colors  
```{r, echo = FALSE, fig.align='center'}

substance_colorbar <- c("#FFBA86", "#FB756C", "#C02A79", "#7D1D67")
substance_colorbar2 <- c("#7D1D67", "#C02A79", "#FB756C","#FFBA86")
 
``` 





# Trajectory Analyses
## Subset DFs
```{r, echo = FALSE}

SU_Vars_Cat <- All_SU_Mod_Long %>% 
  dplyr::select(subject, visit, sex, visit_age,  site, income_recode,raceeth_recode,
                all_gmm_4c_classpast30_Allprob_logp1,
                oClass4_renamed, 
                past_30, Substance, oSubstance) 
SU_Vars_Cat$subject <- as.factor(SU_Vars_Cat$subject)
  
SU_Vars_Cat_Iron <- All_Iron_SU_Mod %>% 
  dplyr::select(subject, visit, sex, visit_age,  site, income_recode,raceeth_recode,
                all_gmm_4c_classpast30_Allprob_logp1,
                oClass4_renamed, 
                tat2.combat, tat2.combat_z, roi) 
SU_Vars_Cat_Iron$subject <- as.factor(SU_Vars_Cat_Iron$subject)

SU_Vars_Cat_UPPS <- All_SU_Mod %>% 
  dplyr::select(subject, visit, sex, visit_age, age_at_baseline, site, income_recode,raceeth_recode,
                all_gmm_4c_classpast30_Allprob_logp1, 
                           oClass4_renamed, 
                contains("upps")) 
SU_Vars_Cat_UPPS$subject <- as.factor(SU_Vars_Cat_UPPS$subject)


SU_Vars_Cat_UPPS2 <- All_UPPS_Mod_Long %>% 
  dplyr::select(subject, visit, sex, visit_age, age_at_baseline, site, income_recode,raceeth_recode,
                all_gmm_4c_classpast30_Allprob_logp1, 
                          oClass4_renamed, 
                Score, Subscale) 
SU_Vars_Cat_UPPS2$subject <- as.factor(SU_Vars_Cat_UPPS2$subject)


SU_Vars_Cat_Anti <- All_AS_Mod %>% 
  dplyr::select(subject, visit, sex, visit_age, age_at_baseline, site, income_recode,raceeth_recode,
                all_gmm_4c_classpast30_Allprob_logp1, 
                oClass4_renamed, 
                cogRewType, contains("corrat")) 
SU_Vars_Cat_Anti <- SU_Vars_Cat_Anti[!is.na(SU_Vars_Cat_Anti$cogRewType),]
SU_Vars_Cat_Anti <- SU_Vars_Cat_Anti[!is.na(SU_Vars_Cat_Anti$oClass4_renamed),]

SU_Vars_Cat_Anti$subject <- as.factor(SU_Vars_Cat_Anti$subject)


SU_Vars_Cat_Anti2 <- All_AS_Mod2 %>% 
  dplyr::select(subject, visit, sex, visit_age, age_at_baseline, site, income_recode,raceeth_recode,
               all_gmm_4c_classpast30_Allprob_logp1, 
                           oClass4_renamed, oCogRewType,
                cogRewType, contains("corrat")) 
SU_Vars_Cat_Anti2 <- SU_Vars_Cat_Anti2[!is.na(SU_Vars_Cat_Anti2$cogRewType),]
SU_Vars_Cat_Anti2 <- SU_Vars_Cat_Anti2[!is.na(SU_Vars_Cat_Anti2$oClass4_renamed),]
SU_Vars_Cat_Anti2$cogRewType <- as.factor(SU_Vars_Cat_Anti2$cogRewType)
SU_Vars_Cat_Anti2$subject <- as.factor(SU_Vars_Cat_Anti2$subject)

``` 

# SUBSTANCE USE

## Test for Differences in Magnitude/Mean/Peak across Substances within trajectory groups
```{r, echo = FALSE, fig.align='center'}

SU_Results.SU <- data.frame(
  oSubstance = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.SU <- data.frame(oSubstance = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())

# Loop through each level of oSubstance
for (s in unique(SU_Vars_Cat$oSubstance)) {
  
  # Subset data for the current substance
  sub_df <- SU_Vars_Cat %>% filter(oSubstance == s)
  # Try fitting the model
  model <- mgcv::gamm(
      past_30 ~ s(visit_age, k = 4, fx = FALSE, bs = "cs") + oClass4_renamed + income_recode +
        raceeth_recode + sex + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model$gam)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Results.SU <- rbind(SU_Results.SU, data.frame(
      oSubstance = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
      
      
    ))
    
    get_preds <- ggpredict(model$gam,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.SU <- rbind(gam.pred.SU, data.frame(
        oSubstance = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }

 
#Peak Substance Use 

unique_peak_df <- dplyr::select(All_SU_Mod_Long, subject, sex, oIncome_recode, oRaceeth_recode, site, peak_SU, peak_age_SU,oSubstance, oClass4_renamed) 
unique_peak_df <- unique(unique_peak_df)


# Initialize empty results data frame
SU_Peak_Results.SU <- data.frame(
  oSubstance = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.Peak_SU <- data.frame(oSubstance = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())

# Loop through each level of oSubstance
for (s in unique(unique_peak_df$oSubstance)) {
  
  # Subset data for the current substance
  sub_df <- unique_peak_df %>% filter(oSubstance == s)
  # Try fitting the model
  model <- mgcv::gam(
      peak_SU ~ oClass4_renamed + sex + oIncome_recode + oRaceeth_recode + site,
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Peak_Results.SU <- rbind(SU_Peak_Results.SU, data.frame(
      oSubstance = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.Peak_SU <- rbind(gam.pred.Peak_SU, data.frame(
        oSubstance = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }

custom_order <- c("All Prob", "Alcohol", "Binge", "Cannabis", "Nicotine")
custom_order2 <- c("Adolescent", "Early Increase", "Late Increase", "Low")

# Convert to factor with levels in custom order
SU_Results.SU <- SU_Results.SU %>%
  mutate(oSubstance = factor(oSubstance, levels = custom_order)) %>%
  arrange(oSubstance)

gam.pred.SU <- gam.pred.SU %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oSubstance = factor(oSubstance, levels = custom_order)) %>%
  arrange(oSubstance, oClass4_renamed)

SU_Peak_Results.SU <- SU_Peak_Results.SU %>%
  mutate(oSubstance = factor(oSubstance, levels = custom_order)) %>%
  arrange(oSubstance)


gam.pred.Peak_SU <- gam.pred.Peak_SU %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oSubstance = factor(oSubstance, levels = custom_order)) %>%
  arrange(oSubstance, oClass4_renamed)

write.csv(SU_Results.SU, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Main_Effects_TrajectoryGroup_Across_Substances.csv', row.names = FALSE)

write.csv(SU_Peak_Results.SU, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Main_Effects_TrajectoryGroup_Across_Substances.csv', row.names = FALSE)

write.csv(gam.pred.SU, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Predicted_TrajectoryGroup_Across_Substances.csv', row.names = FALSE)

write.csv(gam.pred.Peak_SU, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Predicted_TrajectoryGroup_Across_Substances.csv', row.names = FALSE)

``` 

### Raw Plots: 
```{r, echo = FALSE, fig.align='center'}
 
#Distribution of SU among trajectory groups: Violins 

Traj_Violin <- All_SU_Mod_Long %>%
  # mutate(has_nonzero = any(past_30 > 0, na.rm = TRUE)) %>% #COMMENT IN/OUT IF EXCLUDING ON ALL PEOPLE WHO SHOW NO SU OVER ALL VISITS
  #Keep only subjects who have at least one non-zero value
  # filter(has_nonzero == TRUE) %>%
  ggplot( aes(y=oClass4_renamed, x=past_30, fill=oClass4_renamed, color=oClass4_renamed)) +facet_wrap(~oSubstance, scales = "free")+
  scale_color_manual(values=substance_colorbar2)+ 
   scale_fill_manual(values=substance_colorbar2)+ 
    geom_violin(width=1, size=1,adjust = 2) +
      stat_summary(fun = mean, geom = "point", shape = 15, size = 3, color = "black") +   
    theme(aspect.ratio=1.5, legend.position = "none",
                       strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  labs(x = "\nSubstance Use (Days)",
       y = "Substance\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))
print(Traj_Violin)

# Distribution of peak ages among trajectory groups: Hists 
peakdens.peak_age = dplyr::select(All_SU_Mod_Long[!is.na(All_SU_Mod_Long$peak_age_SU),],
                              oClass4_renamed,past_30,peak_age_SU) %>%
  group_by(subject) %>%
  # mutate(has_nonzero = any(past_30 > 0, na.rm = TRUE)) %>%
  # Keep only subjects who have at least one non-zero value
  # filter(has_nonzero == TRUE) %>%

                               group_by(oClass4_renamed,Substance) %>%
                               summarise(Max_Dense = density(peak_age_SU)$x[which.max(density(peak_age_SU, na.rm=T)$y)])

   
Traj_dense_peak <- All_SU_Mod_Long %>%  
mutate(has_nonzero = any(past_30 > 0, na.rm = TRUE)) %>% #COMMENT IN/OUT IF EXCLUDING ON ALL PEOPLE WHO SHOW NO SU OVER ALL VISITS
# Keep only subjects who have at least one non-zero value
filter(has_nonzero == TRUE) %>%
  ggplot(aes(x = peak_age_SU, group = oClass4_renamed, colour = oClass4_renamed)) +
  scale_color_manual(values=substance_colorbar2)+facet_wrap(~Substance, scales = "free")+
  geom_density(linewidth = 1, bw = .80) + 
   theme(aspect.ratio=1.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
    scale_y_continuous(limits = c(0,.27), breaks = seq(0, .25, by = .05))+
    scale_x_continuous(limits = c(10, 30), breaks = seq(10, 30, by = 10))+
    geom_vline(data = subscale_summary, aes(xintercept=mean_peak_age_SU,color = oClass4_renamed), linetype="dashed") +
   labs(x = "\nAge of Peak Use",
       y = "Density\n")
plot(Traj_dense_peak)

# Distribution of age of initiation among trajectory groups: Hists 
Traj_dense_initiation <- All_SU_Mod_Long %>%   
# mutate(has_nonzero = any(past_30 > 0, na.rm = TRUE)) %>% #COMMENT IN/OUT IF EXCLUDING ON ALL PEOPLE WHO SHOW NO SU OVER ALL VISITS
  # Keep only subjects who have at least one non-zero value
  # filter(has_nonzero == TRUE) %>%
  ggplot(aes(x = Age_of_first_use, group = oClass4_renamed, colour = oClass4_renamed)) +
  scale_color_manual(values=substance_colorbar2)+ facet_wrap(~Substance, scales = "free")+
  geom_density(linewidth = 1, bw = .80) + 
     theme(aspect.ratio=1.5, legend.position = "none",
                        strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
      scale_y_continuous(limits = c(0,.27), breaks = seq(0, .25, by = .05))+
    scale_x_continuous(limits = c(5.25, 30), breaks = seq(10, 30, by = 10))+
  geom_vline(data = subscale_summary,             
             aes(xintercept=mean_onset_age,color = oClass4_renamed), linetype="dashed") +
labs(x = "\nAge of Onset", y = "Density\n")
plot(Traj_dense_initiation)


ggsave(Traj_Violin, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_SU_Violin_AllSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


ggsave(Traj_dense_peak, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_SU_DensePeak_AllSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(Traj_dense_initiation, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_SU_DenseInitiation_AllSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")



subscale_summary$oClass4_renamed2<-ordered(subscale_summary$oClass4_renamed,
levels=c("Adolescent", "Early Increase", "Late Increase","Low"))


p1_5 <- subscale_summary %>% ungroup () %>%  
  ggplot(aes(x = mean_SU, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nSubstance Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(0, 12), breaks = seq(0, 12, by = 4))+ 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5)

  

p2_5 <- subscale_summary %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_SU, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nPeak Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(0, 25), breaks = seq(0, 20, by = 10))+ 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5)


p3_5 <- subscale_summary %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_age_SU, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Peak Use",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(20, 23.2), breaks = seq(20, 23, by = 1))+ 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5)

p4_5 <- subscale_summary %>% ungroup () %>%  
  ggplot(aes(x = mean_onset_age, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Onset",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(15, 18), breaks = seq(15, 18, by = 1))+ #formatted best for general substance use (main)
      # scale_x_continuous(limits = c(15, 20), breaks = seq(15, 20, by = 1))+ #formatted best for general substance use (main)
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p4_5)

ggsave(p1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_Peak_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_Peak_Age_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p4_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_AgeofOnset_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


p1_5_SE <- ggplot(subscale_summary, aes(mean_SU, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_SU-sd_SU, xmax = mean_SU+sd_SU, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
        geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nSubstance Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(0, 12.5), breaks = seq(0, 12, by = 4))+
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_SE)

  

p2_5_SE <- ggplot(subscale_summary, aes(mean_peak_SU, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_SU-sd_peak_SU, xmax = mean_peak_SU+sd_peak_SU, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
      geom_point(shape = 21, size = 5.5, color = NA) +
    facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nPeak Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(0, 25), breaks = seq(0, 20, by = 10))+
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_SE)


p3_5_SE <- ggplot(subscale_summary, aes(mean_peak_age_SU, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_age_SU-SD_peak_age_SU, xmax = mean_peak_age_SU+SD_peak_age_SU, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
      geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Peak Use",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(20, 23.2), breaks = seq(20, 23, by = 1))+
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5_SE)

p4_5_SE <- ggplot(subscale_summary, aes(mean_onset_age, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_onset_age-SD_onset_age, xmax = mean_onset_age+SD_onset_age, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
        geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~Substance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Onset",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(15, 18), breaks = seq(15, 18, by = 1))+ #formatted best for general substance use (main)
      # scale_x_continuous(limits = c(15, 20), breaks = seq(15, 20, by = 1))+ #formatted best for general substance use (main)
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p4_5_SE)


ggsave(p1_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_Peak_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_Peak_Age_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p4_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_AgeofOnset_SE_ALLSubstances.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

``` 

### Prediction Plots: Predicted Values for Mean SU
```{r, echo = FALSE, fig.align='center'}

p1_5_v <- gam.pred.SU %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nSubstance Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(0, 10), breaks = seq(0, 10, by = 5))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_v)

#Pred:
p1_5_v_se <- ggplot(gam.pred.SU, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oSubstance, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nSubstance Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(1, 11), breaks = seq(2, 10, by = 2))+ #Formatted best for general SU 
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p1_5_v_se)

#Predicted Peak values 

p2_5_v <- gam.pred.Peak_SU %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak Substance Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(0, 25), breaks = seq(0, 25, by = 5))+ #Formatted for general substance use (overall)
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_v)

#Pred:
p2_5_v_se <- ggplot(gam.pred.Peak_SU, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oSubstance, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak Substance Use (Days)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(-.5, 25), breaks = seq(0, 25, by = 5))+ #Formatted best for general SU
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p2_5_v_se)



ggsave(p1_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_ALLSubstances_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_Peak_ALLSubstances_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p1_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_ALLSubstances_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_Peak_ALLSubstances_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 

``` 

## Characterize age changes across Substances within trajectory groups 
```{r, echo = FALSE, fig.align='center'}


substance <- levels(SU_Vars_Cat$oSubstance)
traj <- levels(SU_Vars_Cat$oClass4_renamed)

# Initialize output containers
gam.statistics <- data.frame(
  oSubstance = factor(),
  oClass4_renamed = factor(),
  GAM.smooth_Fvalue = numeric(),
  GAM.smooth_RSq = numeric(),
  GAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric(),
  max.age.fitted = numeric(),
  max.val.fitted = numeric()
)

gam.fittedvalues <- data.frame(
  oSubstance = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  fitted = numeric(),
  fitted2 = numeric(),
  se = numeric(),
  lower_ci = numeric(),
  upper_ci = numeric()
)

gam.smoothestimates <- data.frame(
  oSubstance = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  estimate = numeric(),
  se = numeric()
)

gam.derivatives <- data.frame(
  oSubstance = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  derivative = numeric(),
  lower = numeric(),
  upper = numeric(),
  significant = numeric(),
  significant_deriv = numeric()
)

gam.pred <- data.frame(
  oSubstance = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  predicted = numeric(),
  se = numeric(),
  lower = numeric(),
  upper = numeric()
)

# ----------------------------
# Loop over Substances & Trajectory groups
# ----------------------------
for (subst in substance) {
  for (sx in traj) {
    
    sub_df <- SU_Vars_Cat %>%
      filter(oSubstance == subst, oClass4_renamed == sx)
    
    # if (nrow(sub_df) < 10) next  # skip if too few rows
    
    gam.model <- mgcv::gamm(
      past_30 ~ s(visit_age, k = 4, fx = F, bs = "cs"),#sex + income_recode + raceeth_recode + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML"
    )
    
    gam.results <- summary(gam.model$gam)
    df <- as.data.frame(unclass(gam.model$gam$model), stringsAsFactors = TRUE)
    
    np <- 200
    pred <- data.frame(visit_age = seq(min(df$visit_age, na.rm = TRUE),
                                       max(df$visit_age, na.rm = TRUE),
                                       length.out = np))
    
    ## Derivatives
    derv <- gratia::derivatives(gam.model, term = "s(visit_age)", 
                                data = pred, interval = "simultaneous", unconditional = FALSE)
    derv <- derv %>% mutate(sig = !(0 > .lower_ci & 0 < .upper_ci),
                            sig_deriv = .derivative * sig)
    
    mean.derivative <- mean(derv$.derivative)
    gam.smooth.F <- gam.results$s.table[1,3]
    gam.smooth.Rsq <- gam.results$r.sq
    if(mean.derivative < 0) gam.smooth.F <- -gam.smooth.F
    gam.smooth.pvalue <- gam.results$s.table[1,4]
    
    ## Temporal characteristics
    change.onset <- ifelse(any(derv$sig), min(derv$visit_age[derv$sig]), NA)
    peak.change <- ifelse(any(derv$sig),
                          mean(derv$visit_age[which.max(abs(derv$sig_deriv))]),
                          NA)
    decrease.onset <- ifelse(any(derv$sig_deriv < 0), min(derv$visit_age[derv$sig_deriv < 0]), NA)
    decrease.offset <- ifelse(any(derv$sig_deriv < 0), max(derv$visit_age[derv$sig_deriv < 0]), NA)
    increase.onset <- ifelse(any(derv$sig_deriv > 0), min(derv$visit_age[derv$sig_deriv > 0]), NA)
    increase.offset <- ifelse(any(derv$sig_deriv > 0), max(derv$visit_age[derv$sig_deriv > 0]), NA)
    change.offset <- ifelse(any(derv$sig), max(derv$visit_age[derv$sig]), NA)
    
    ## Fitted values & maxval2
    gam.fittedvalues_temp <- gratia::fitted_values(gam.model, data = pred)
    gam.fittedvalues_temp$.fitted2 <- plogis(gam.fittedvalues_temp$.fitted) * 30
    
    maxval2 <- max(gam.fittedvalues_temp$.fitted, na.rm = TRUE)
    max.age.fitted <- gam.fittedvalues_temp$visit_age[which.max(gam.fittedvalues_temp$.fitted)]
    
    ## Save stats
    gam.statistics <- bind_rows(gam.statistics, data.frame(
      oSubstance = subst,
      oClass4_renamed = sx,
      GAM.smooth_Fvalue = gam.smooth.F,
      GAM.smooth_RSq = gam.smooth.Rsq,
      GAM.smooth.pvalue = gam.smooth.pvalue,
      smooth.change.onset = change.onset,
      smooth.peak.change = peak.change,
      smooth.decrease.onset = decrease.onset,
      smooth.decrease.offset = decrease.offset,
      smooth.increase.onset = increase.onset,
      smooth.increase.offset = increase.offset,
      smooth.last.change = change.offset,
      max.age.fitted = max.age.fitted,
      max.val.fitted = maxval2
    ))
    
    ## Save fitted values
    gam.fittedvalues <- bind_rows(gam.fittedvalues, data.frame(
      oSubstance = subst, oClass4_renamed = sx,
      visit_age = gam.fittedvalues_temp$visit_age,
      fitted = gam.fittedvalues_temp$.fitted,
      fitted2 = gam.fittedvalues_temp$.fitted2,
      se = gam.fittedvalues_temp$.se,
      lower_ci = gam.fittedvalues_temp$.lower_ci,
      upper_ci = gam.fittedvalues_temp$.upper_ci
    ))
    
    ## Save smooth estimates
    gam.smoothvalues_temp <- gratia::smooth_estimates(gam.model, data = pred, smooth = "s(visit_age)")
    gam.smoothestimates <- bind_rows(gam.smoothestimates, data.frame(
      oSubstance = subst, oClass4_renamed = sx,
      visit_age = gam.smoothvalues_temp$visit_age,
      estimate = gam.smoothvalues_temp$.estimate,
      se = gam.smoothvalues_temp$.se
    ))
    
    ## Save derivatives
    gam.derivatives <- bind_rows(gam.derivatives, data.frame(
      oSubstance = subst, oClass4_renamed = sx,
      visit_age = derv$visit_age,
      derivative = derv$.derivative,
      lower = derv$.lower_ci,
      upper = derv$.upper_ci,
      significant = derv$sig,
      significant_deriv = derv$sig_deriv
    ))
    
    ## Save predictions
    gam.pred_temp <- ggpredict(gam.model, terms=c("visit_age"))
    gam.pred <- bind_rows(gam.pred, data.frame(
      oSubstance = subst, oClass4_renamed = sx,
      visit_age = gam.pred_temp$x,
      predicted = gam.pred_temp$predicted,
      se = gam.pred_temp$std.error,
      lower = gam.pred_temp$conf.low,
      upper = gam.pred_temp$conf.high
    ))
  }
}

# Average derivative per group
deriv_rate <- gam.derivatives %>%
  group_by(oSubstance, oClass4_renamed) %>%
  dplyr::summarise(deriv_rate = mean(derivative, na.rm = TRUE), .groups = "drop")

gam.statistics_traj <- left_join(gam.statistics, deriv_rate, by = c("oSubstance","oClass4_renamed"))
gam.fittedvalues_traj <- gam.fittedvalues
gam.pred_traj <- gam.pred
gam.derivatives_traj <- gam.derivatives


custom_order <- c("All Prob", "Alcohol", "Binge", "Cannabis", "Nicotine")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
gam.statistics_traj <- gam.statistics_traj %>%
  mutate(oSubstance = factor(oSubstance, levels = custom_order),
         oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  arrange(oSubstance, oClass4_renamed)

write.csv(gam.statistics_traj, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Smooth_Statistics_Across_Substances_TrajectoryGroups.csv', row.names = FALSE)

 
``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}


age1a <- ggplot(gam.pred_traj,
                    aes(x=visit_age, y=predicted, color=oClass4_renamed,fill=oClass4_renamed))+
  geom_line(linewidth = 1) + facet_wrap(~oSubstance, scales = "free")+
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, legend.position = "none",
             strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
labs(x = "\nAge",
       y = "Substance Use (Days)\n")
print(age1a)


age1b <- ggplot(All_SU_Mod_Long,
                    aes(x=visit_age, y=past_30, color=oClass4_renamed,fill=oClass4_renamed))+
  geom_smooth(method="gam", span = .75, formula = y ~ s(x, k = 4, fx = FALSE, bs = "cs"))+ facet_wrap(~oSubstance, scales = "free")+
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
 scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
labs(x = "\nAge",
       y = "Substance Use (Days)\n")
print(age1b)

#Pie Chart
n <- All_Models_past30prob_logp1 %>%group_by(oClass4_renamed)%>%tally()

 # Basic piechart
pie_ch <- ggplot(n, aes(x="", y=n, fill=oClass4_renamed)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
     scale_fill_manual(values=substance_colorbar2)+
  theme_void() # remove background, grid, numeric labels

# Age by SU: Trajectories separately, main SU trajectories shown 
age2 <- All_SU_Mod_Long %>% filter(oSubstance=="All Prob") %>% ggplot(
                    aes(x=visit_age, y=past_30, color=oClass4_renamed,fill=oClass4_renamed))+ 
  geom_line(data= All_SU_Mod_Long%>% filter(oSubstance=="All Prob"),
            aes(y=past_30, x = visit_age, group=subject), alpha=.1, color = "black",
            linewidth = .25)+ facet_wrap(~oClass4_renamed, scales = "free")+ 
  scale_fill_manual(values = substance_colorbar2)+ 
  scale_color_manual(values = substance_colorbar2)+ 
  geom_smooth(method="gam", formula = y ~ s(x, k = 4, fx = FALSE,bs = "cs"))+
  theme(legend.position = "none", aspect.ratio=.5, 
                               strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
  scale_y_continuous(limits = c(-3, 30), breaks = seq(0, 30, by = 10))+
  labs(x = "\nAge",
       y = "Substance Use (Days)\n")
print(age2)

# Derivative plots for SU: Trajectories separately 
derv<- gam.derivatives_Adolescent[gam.derivatives_Adolescent$Substance=="All Prob",] 
d1<- ggplot(data=derv) + geom_tile(aes(x = visit_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = substance_colorbar2[1], midpoint = 0, mid = "white",
                           high = substance_colorbar2[1])+#, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_text(size = 8, family = "Arial", color = c("black")),
          axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
          axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
          axis.line = element_line(linewidth = .2), 
          axis.ticks = element_line(linewidth = .2),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "bottom",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + geom_vline(data = gam.statistics_Adolescent[gam.statistics_Adolescent$Substance=="All Prob",], aes(xintercept=smooth.increase.offset), color="black") +
      geom_vline(data = gam.statistics_Adolescent[gam.statistics_Adolescent$Substance=="All Prob",], aes(xintercept=smooth.increase.onset), color="black") +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5)) +
geom_vline(data = gam.statistics_Adolescent[gam.statistics_Adolescent$Substance=="All Prob",], aes(xintercept=smooth.decrease.offset), color="black") +
      geom_vline(data = gam.statistics_Adolescent[gam.statistics_Adolescent$Substance=="All Prob",], aes(xintercept=smooth.decrease.onset), color="black") +
         labs(y="All", x="Age")

derv<- gam.derivatives_Early[gam.derivatives_Early$Substance=="All Prob",] 
d2<- ggplot(data=derv) + geom_tile(aes(x = visit_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = substance_colorbar2[2], midpoint = 0, mid = "white",
                           high = substance_colorbar2[2])+#, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_text(size = 8, family = "Arial", color = c("black")),
          axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
          axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
          axis.line = element_line(linewidth = .2), 
          axis.ticks = element_line(linewidth = .2),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "bottom",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + geom_vline(data = gam.statistics_Early[gam.statistics_Early$Substance=="All Prob",], aes(xintercept=smooth.increase.offset), color="black") +
      geom_vline(data = gam.statistics_Early[gam.statistics_Early$Substance=="All Prob",], aes(xintercept=smooth.increase.onset), color="black") +
  geom_vline(data = gam.statistics_Early[gam.statistics_Early$Substance=="All Prob",], aes(xintercept=smooth.decrease.offset), color="black") +
      geom_vline(data = gam.statistics_Early[gam.statistics_Early$Substance=="All Prob",], aes(xintercept=smooth.decrease.onset), color="black") +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
        labs(y="All", x="Age")


derv<- gam.derivatives_Late[gam.derivatives_Late$Substance=="All Prob",] 
d3<- ggplot(data=derv) + geom_tile(aes(x = visit_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = substance_colorbar2[3], midpoint = 0, mid = "white",
                           high = substance_colorbar2[3])+#, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_text(size = 8, family = "Arial", color = c("black")),
          axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
          axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
          axis.line = element_line(linewidth = .2), 
          axis.ticks = element_line(linewidth = .2),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "bottom",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + geom_vline(data = gam.statistics_Late[gam.statistics_Late$Substance=="All Prob",], aes(xintercept=smooth.increase.offset), color="black") +
      geom_vline(data = gam.statistics_Late[gam.statistics_Late$Substance=="All Prob",], aes(xintercept=smooth.increase.onset), color="black") +
  geom_vline(data = gam.statistics_Late[gam.statistics_Late$Substance=="All Prob",], aes(xintercept=smooth.decrease.offset), color="black") +
      geom_vline(data = gam.statistics_Late[gam.statistics_Late$Substance=="All Prob",], aes(xintercept=smooth.decrease.onset), color="black") +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
        labs(y="All", x="Age")


derv<- gam.derivatives_Low[gam.derivatives_Low$Substance=="All Prob",] 
d4<- ggplot(data=derv) + geom_tile(aes(x = visit_age, y = .5, fill = significant_deriv))+
      scale_fill_gradient2(low = substance_colorbar2[4], midpoint = 0, mid = "white",
                           high = substance_colorbar2[4])+#, limits = c(0, max_val))+ 
    theme(aspect.ratio = .05, panel.grid.major = element_blank(),
          panel.grid.minor=element_blank(),
          panel.background=element_blank(), 
          axis.text = element_text(size = 8, family = "Arial", color = c("black")),
          axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
          axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
          axis.line = element_line(linewidth = .2), 
          axis.ticks = element_line(linewidth = .2),
          legend.key.width = unit(1,"cm"),
          legend.key.height = unit(.5,"cm"),
          legend.position = "bottom",
          plot.margin = unit(c(0, 0, 0, 0), "cm"))+
    guides(fill = guide_colorbar(reverse = F,direction = "horizontal",title.position = "top")) + geom_vline(data = gam.statistics_Low[gam.statistics_Low$Substance=="All Prob",], aes(xintercept=smooth.increase.offset), color="black") +
      geom_vline(data = gam.statistics_Low[gam.statistics_Low$Substance=="All Prob",], aes(xintercept=smooth.increase.onset), color="black") +
  geom_vline(data = gam.statistics_Low[gam.statistics_Low$Substance=="All Prob",], aes(xintercept=smooth.decrease.offset), color="black") +
      geom_vline(data = gam.statistics_Low[gam.statistics_Low$Substance=="All Prob",], aes(xintercept=smooth.decrease.onset), color="black") +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
        labs(y="All", x="Age")


Derv1 <- ggarrange(d1, d2, d3, 
                   ncol = 3, nrow = 1)
  
Derv2 <- ggarrange(d4, 
                   ncol = 3, nrow = 1)


ggsave(pie_ch, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Pie_Chart.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


ggsave(age1a, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllSubstances_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age1b, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllSubstances_Raw.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age2, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllSU_Sep.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(Derv1, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_Deriv1_AllSU_Sep.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


ggsave(Derv2, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_Deriv2_AllSU_Sep.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


gam.statistics_traj$oSubstance <- ordered(gam.statistics_traj$oSubstance, levels = c("All Prob","Alcohol", 
                                                                          "Cannabis",
                                                                          "Nicotine", "Binge"))
      

gam.statistics_traj$oClass4_renamed2 <- ordered(gam.statistics_traj$oClass4_renamed, 
                                                levels = c("Adolescent","Early Increase", "Late Increase",
                                                           "Low"))
      

age1_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = max.age.fitted, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nAge of Peak Use (smooth)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(22, 30), breaks = seq(22, 30, by = 2))+
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age1_5)


age2_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = deriv_rate, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nRate of Increase",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
   scale_x_continuous(limits = c(0, 2.2), breaks = seq(0, 2, by = 1))+
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age2_5)


age3_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.last.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
 geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nAge of Maturation",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
   scale_x_continuous(limits = c(22, 30), breaks = seq(22, 30, by = 2))+
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
   legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age3_5)


age4_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.peak.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
 geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nAge of Peak Change",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
   scale_x_continuous(limits = c(12, 30), breaks = seq(12, 30, by = 4))+
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
   legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age4_5)

age5_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.increase.onset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
 geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nIncrease Onset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
   scale_x_continuous(limits = c(12, 18), breaks = seq(12, 18, by = 2))+ #Formatted for general substance use (main)
   # scale_x_continuous(limits = c(12, 22), breaks = seq(12, 22, by = 2))+ #Formatted for consistency across substances
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
   legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age5_5)




age6_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.increase.offset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nIncrease Offset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
   scale_x_continuous(limits = c(20, 30), breaks = seq(20, 30, by = 5))+
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
   legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age6_5)


age7_5 <- gam.statistics_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.decrease.onset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubstance, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nDecrease Onset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
   scale_x_continuous(limits = c(20, 30), breaks = seq(20, 30, by = 5))+
  theme(aspect.ratio = 1.5,
  strip.background = element_blank(),
   legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age7_5)

ggsave(age1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_PeakSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_IncreaseRateSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_MatureAgeSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age4_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_PeakChangeSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 

ggsave(age5_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_IncONAgeSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 


ggsave(age6_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_IncOFFAgeSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 

ggsave(age7_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubstances_Gam_Stats_DecONAgeSU.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 

``` 

# Demographic Group Membership
## Plots 

```{r, echo = FALSE, fig.align='center'}

Demo <- dplyr::select(All_SU_Mod_Long, oRaceeth_recode, oIncome_recode, sex, site, oClass4_renamed, subject)
Demo <- unique(Demo)
 
All <- dplyr::select(Demo, oClass4_renamed) 
All$Label <- "All"
Race <- dplyr::select(Demo, oClass4_renamed, oRaceeth_recode) %>%
  dplyr::rename(Label = oRaceeth_recode) 
Income <- dplyr::select(Demo, oClass4_renamed, oIncome_recode) %>%
  dplyr::rename(Label = oIncome_recode) 
sex <- dplyr::select(Demo, oClass4_renamed, sex) %>%
  dplyr::rename(Label = sex) 
site <- dplyr::select(Demo, oClass4_renamed, site) %>%
  dplyr::rename(Label = site) 

All_Demo <- rbind(All,Race, Income, sex, site)

All_Demo$oLabel<-ordered(All_Demo$Label,
levels=c("E", "D", "C","B", "A", "Other","Non-Hispanic Black/AA", "Non-Hispanic White", "Hispanic",
         "Asian AIAN NHPI OTHER", "200k+","100k-199k","75k-99k","50k-74k", "25k-49k","<25k",
         "M","F","All"))


table_All_Demo <- table(All_Demo$oLabel, All_Demo$oClass4_renamed)
chisq.test(table_All_Demo)
chisq <- chisq.test(table_All_Demo)
chisq$stdres  # standardized residuals

mm <- ggplot(as.data.frame(table_All_Demo), aes(y = Var1, x = Freq, fill = Var2)) +
  geom_bar(stat = "identity", position = "fill") +# stacked
    # geom_bar(position = "dodge", stat = "identity")+
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
  ylab("Proportion within group") +
theme(aspect.ratio=1.5, plot.title = element_text(size=24,color="black"), #legend.position = "none",
        axis.text=element_text(size=6,color="black"), axis.title=element_text(size=18,color="black"),
        panel.grid.major.y = element_line(),panel.grid.minor.y=element_line(),
        panel.background=element_blank(), axis.line=element_line(colour="black")) 
 
ggsave(mm, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Demographics_Plot.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

``` 
# IMPULSIVITY

## Test for Differences in Magnitude/Mean/Peak across Subscales within trajectory groups
```{r, echo = FALSE, fig.align='center'}

SU_Results.UPPS <- data.frame(
  oSubscale = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.UPPS <- data.frame(oSubscale = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())

# Loop through each level of oSubstance
for (s in unique(SU_Vars_Cat_UPPS2$oSubscale)) {
  
  # Subset data for the current substance
  sub_df <- SU_Vars_Cat_UPPS2 %>% filter(oSubscale == s)
  # Try fitting the model
  model <- mgcv::gamm(
      Score ~ s(visit_age, k = 4, fx = FALSE, bs = "cs") + oClass4_renamed + income_recode + 
        raceeth_recode + sex + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model$gam)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Results.UPPS <- rbind(SU_Results.UPPS, data.frame(
      oSubscale = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model$gam,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.UPPS <- rbind(gam.pred.UPPS, data.frame(
        oSubscale = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }


#Peak UPPS 

unique_peak_df <- dplyr::select(All_UPPS_Mod_Long, subject, sex, income_recode, raceeth_recode, site, peak_UPPS, peak_age_UPPS,oSubscale,oClass4_renamed) 
unique_peak_df <- unique(unique_peak_df)


# Initialize empty results data frame
SU_Peak_Results.UPPS <- data.frame(
  oSubscale = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.Peak_UPPS <- data.frame(oSubscale = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())

# Loop through each level of oSubstance
for (s in unique(unique_peak_df$oSubscale)) {
  
  # Subset data for the current substance
  sub_df <- unique_peak_df %>% filter(oSubscale == s)
  # Try fitting the model
  model <- mgcv::gam(
      peak_UPPS ~ oClass4_renamed + sex + income_recode + raceeth_recode + site,
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Peak_Results.UPPS <- rbind(SU_Peak_Results.UPPS, data.frame(
      oSubscale = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.Peak_UPPS <- rbind(gam.pred.Peak_UPPS, data.frame(
        oSubscale = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }


custom_order <- c("Mean", "Neg Urg", "Perseverance", "Pos Urg", 
                  "Premeditation", "Sensation Seeking")

custom_order2 <- c("Adolescent", "Early Increase", "Late Increase", "Low")

# Convert to factor with levels in custom order
SU_Results.UPPS <- SU_Results.UPPS %>%
  mutate(oSubscale = factor(oSubscale, levels = custom_order)) %>%
  arrange(oSubscale)


gam.pred.UPPS <- gam.pred.UPPS %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oSubscale = factor(oSubscale, levels = custom_order)) %>%
  arrange(oSubscale, oClass4_renamed)


SU_Peak_Results.UPPS <- SU_Peak_Results.UPPS %>%
  mutate(oSubscale = factor(oSubscale, levels = custom_order)) %>%
  arrange(oSubscale)

gam.pred.Peak_UPPS <- gam.pred.Peak_UPPS %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oSubscale = factor(oSubscale, levels = custom_order)) %>%
  arrange(oSubscale, oClass4_renamed)




write.csv(SU_Results.UPPS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Main_Effects_TrajectoryGroup_Across_UPPSSubscales.csv', row.names = FALSE)

write.csv(SU_Peak_Results.UPPS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Main_Effects_TrajectoryGroup_Across_UPPSSubscales.csv', row.names = FALSE)


write.csv(gam.pred.UPPS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Predicted_TrajectoryGroup_Across_UPPSSubscales.csv', row.names = FALSE)

write.csv(gam.pred.Peak_UPPS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Predicted_TrajectoryGroup_Across_UPPSSubscales.csv', row.names = FALSE)

``` 

### Raw Plots: 
```{r, echo = FALSE, fig.align='center'}
 
#Distribution of SU among trajectory groups: Violins 

Traj_Violin_UPPS <- All_UPPS_Mod_Long %>%
  ggplot( aes(y=oClass4_renamed, x=Score, fill=oClass4_renamed, color=oClass4_renamed)) +facet_wrap(~oSubscale, scales = "free")+
  scale_color_manual(values=substance_colorbar2)+ 
   scale_fill_manual(values=substance_colorbar2)+ 
    geom_violin(width=1, size=1,adjust = 2) +
      stat_summary(fun = mean, geom = "point", shape = 15, size = 3, color = "black") +   
    theme(aspect.ratio=1.5, legend.position = "none",
                       strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  labs(x = "\nScore",
       y = "Subscale\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))
print(Traj_Violin_UPPS)

# Distribution of peak ages among trajectory groups: Hists 

peakdens.peak_age_upps = dplyr::select(All_UPPS_Mod_Long[!is.na(All_UPPS_Mod_Long$peak_age_UPPS),],
                              oClass4_renamed,Score,peak_age_UPPS) %>%
                               group_by(oClass4_renamed,oSubscale) %>%
                               summarise(Max_Dense = density(peak_age_UPPS)$x[which.max(density(peak_age_UPPS, na.rm=T)$y)])
   
Traj_dense_peak_UPPS <- All_UPPS_Mod_Long %>%  
  ggplot(aes(x = peak_age_UPPS, group = oClass4_renamed, colour = oClass4_renamed)) +
  scale_color_manual(values=substance_colorbar2)+facet_wrap(~Subscale, scales = "free")+
  geom_density(linewidth = 1, bw = .80) + 
   theme(aspect.ratio=1.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
    scale_x_continuous(limits = c(10, 30), breaks = seq(10, 30, by = 10))+
    # geom_vline(data = subscale_summary_upps, aes(xintercept=mean_peak_age_UPPS,color = oClass4_renamed), linetype="dashed") +
   labs(x = "\nAge of Peak UPPS",
       y = "Density\n")
plot(Traj_dense_peak_UPPS)


ggsave(Traj_Violin_UPPS, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_UPPS_Violin_AllSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


ggsave(Traj_dense_peak_UPPS, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_UPPS_DensePeak_AllSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


subscale_summary_upps$oClass4_renamed2<-ordered(subscale_summary_upps$oClass4_renamed,
levels=c("Adolescent", "Early Increase", "Late Increase","Low"))


p1_5 <- subscale_summary_upps %>% ungroup () %>%  
  ggplot(aes(x = mean_UPPS, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nUPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(1.8, 2.1), breaks = seq(1.8, 2.1, by = .1))+ #Formatted for mean UPPS
      # scale_x_continuous(limits = c(1.4, 3.0), breaks = seq(1.4, 3, by = .4))+ #Formatted for consistency across subscales 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5)


p2_5 <- subscale_summary_upps %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_UPPS, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nPeak UPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(2, 2.5), breaks = seq(2, 2.5, by = .25))+ #Formatted for mean UPPS
      # scale_x_continuous(limits = c(2, 3.5), breaks = seq(2, 3.5, by = .5))+ #Formatted for consistency across subscales
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5)

p3_5 <- subscale_summary_upps %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_age_UPPS, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Peak UPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(17.4, 19), breaks = seq(17.5, 19, by = .5))+ #formatting best for mean UPPS
      # scale_x_continuous(limits = c(17, 20), breaks = seq(17, 20, by = 1))+ #formatting best for consistency across subscales 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5)

 
ggsave(p1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_ALLSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_Peak_ALLSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_Peak_Age_ALLSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

p1_5_SE <- ggplot(subscale_summary_upps, aes(mean_UPPS, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_UPPS-sd_UPPS, xmax = mean_UPPS+sd_UPPS, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
        geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
    labs(x = "\nUPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(1.79, 2.05), breaks = seq(1.80, 2.0, by = .10))+ #Formatted best for mean UPPS
    # scale_x_continuous(limits = c(1.4, 3), breaks = seq(1.5, 3, by = .5))+ #Formatted best for consistency across subscales 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_SE)

  

p2_5_SE <- ggplot(subscale_summary_upps, aes(mean_peak_UPPS, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_UPPS-sd_peak_UPPS, xmax = mean_peak_UPPS+sd_peak_UPPS, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
      geom_point(shape = 21, size = 5.5, color = NA) +
    facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nPeak UPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(2, 2.5), breaks = seq(2, 2.5, by = .25))+ #Formatted best for mean UPPS
    # scale_x_continuous(limits = c(1.8, 3.5), breaks = seq(2, 3.5, by = .5))+ #Formatted best for consistency across subscales
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_SE)


p3_5_SE <- ggplot(subscale_summary_upps, aes(mean_peak_age_UPPS, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_age_UPPS-SD_peak_age_UPPS, xmax = mean_peak_age_UPPS+SD_peak_age_UPPS, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
      geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Peak UPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(17, 19), breaks = seq(17, 19, by = 1))+ #Formatted best for mean UPPS
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5_SE)


ggsave(p1_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_SE_ALLSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_SE_Peak_ALLSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_SE_Peak_Age_ALLSubscales.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")



``` 

### Prediction Plots: Predicted Values for Mean UPPS
```{r, echo = FALSE, fig.align='center'}

p1_5_v <- gam.pred.UPPS %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nUPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(1.95, 2.20), breaks = seq(2, 2.20, by = .1))+#Formatted for Mean UPPS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_v)

#Pred:
p1_5_v_se <- ggplot(gam.pred.UPPS, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oSubscale, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nUPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(1.8, 2.3), breaks = seq(1.8, 2.2, by = .2))+ #Formatted best for mean UPPS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p1_5_v_se)

#Predicted Peak values 

p2_5_v <- gam.pred.Peak_UPPS %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak UPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(2.1, 2.4), breaks = seq(2.1, 2.4, by = .1))+ #Formatted for mean UPPS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_v)

#Pred:
p2_5_v_se <- ggplot(gam.pred.Peak_UPPS, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oSubscale, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak UPPS Score",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(2, 2.5), breaks = seq(2, 2.5, by = .25))+ #Formatted best for mean UPPS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p2_5_v_se)



ggsave(p1_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_ALLSubscales_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_Peak_ALLSubscales_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p1_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_SE_ALLSubscales_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanUPPS_SE_Peak_ALLSubscales_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


``` 

## Characterize age changes across Subscales within trajectory groups 
```{r, echo = FALSE, fig.align='center'}

subscale <- levels(SU_Vars_Cat_UPPS2$oSubscale)
traj <- levels(SU_Vars_Cat_UPPS2$oClass4_renamed)

# Initialize output containers
gam.statistics <- data.frame(
  oSubscale = factor(),
  oClass4_renamed = factor(),
  GAM.smooth_Fvalue = numeric(),
  GAM.smooth_RSq = numeric(),
  GAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric(),
  max.age.fitted = numeric(),
  max.val.fitted = numeric()
)

gam.fittedvalues <- data.frame(
  oSubscale = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  fitted = numeric(),
  fitted2 = numeric(),
  se = numeric(),
  lower_ci = numeric(),
  upper_ci = numeric()
)

gam.smoothestimates <- data.frame(
  oSubscale = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  estimate = numeric(),
  se = numeric()
)

gam.derivatives <- data.frame(
  oSubscale = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  derivative = numeric(),
  lower = numeric(),
  upper = numeric(),
  significant = numeric(),
  significant_deriv = numeric()
)

gam.pred <- data.frame(
  oSubscale = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  predicted = numeric(),
  se = numeric(),
  lower = numeric(),
  upper = numeric()
)

# ----------------------------
# Loop over subscales & Trajectory groups
# ----------------------------
for (subst in subscale) {
  for (sx in traj) {
    
    sub_df <- SU_Vars_Cat_UPPS2 %>%
      filter(oSubscale == subst, oClass4_renamed == sx)
    
    # if (nrow(sub_df) < 10) next  # skip if too few rows
    
    gam.model <- mgcv::gamm(
      Score ~ s(visit_age, k = 4, fx = F, bs = "cs"),#+ sex + income_recode + raceeth_recode + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML"
    )
    
    gam.results <- summary(gam.model$gam)
    df <- as.data.frame(unclass(gam.model$gam$model), stringsAsFactors = TRUE)
    
    np <- 200
    pred <- data.frame(visit_age = seq(min(df$visit_age, na.rm = TRUE),
                                       max(df$visit_age, na.rm = TRUE),
                                       length.out = np))
    
    ## Derivatives
    derv <- gratia::derivatives(gam.model, term = "s(visit_age)", 
                                data = pred, interval = "simultaneous", unconditional = FALSE)
    derv <- derv %>% mutate(sig = !(0 > .lower_ci & 0 < .upper_ci),
                            sig_deriv = .derivative * sig)
    
    mean.derivative <- mean(derv$.derivative)
    gam.smooth.F <- gam.results$s.table[1,3]
    gam.smooth.Rsq <- gam.results$r.sq
    if(mean.derivative < 0) gam.smooth.F <- -gam.smooth.F
    gam.smooth.pvalue <- gam.results$s.table[1,4]
    
    ## Temporal characteristics
    change.onset <- ifelse(any(derv$sig), min(derv$visit_age[derv$sig]), NA)
    peak.change <- ifelse(any(derv$sig),
                          mean(derv$visit_age[which.max(abs(derv$sig_deriv))]),
                          NA)
    decrease.onset <- ifelse(any(derv$sig_deriv < 0), min(derv$visit_age[derv$sig_deriv < 0]), NA)
    decrease.offset <- ifelse(any(derv$sig_deriv < 0), max(derv$visit_age[derv$sig_deriv < 0]), NA)
    increase.onset <- ifelse(any(derv$sig_deriv > 0), min(derv$visit_age[derv$sig_deriv > 0]), NA)
    increase.offset <- ifelse(any(derv$sig_deriv > 0), max(derv$visit_age[derv$sig_deriv > 0]), NA)
    change.offset <- ifelse(any(derv$sig), max(derv$visit_age[derv$sig]), NA)
    
    ## Fitted values & maxval2
    gam.fittedvalues_temp <- gratia::fitted_values(gam.model, data = pred)
    gam.fittedvalues_temp$.fitted2 <- plogis(gam.fittedvalues_temp$.fitted) * 30
    
    maxval2 <- max(gam.fittedvalues_temp$.fitted, na.rm = TRUE)
    max.age.fitted <- gam.fittedvalues_temp$visit_age[which.max(gam.fittedvalues_temp$.fitted)]
    
    ## Save stats
    gam.statistics <- bind_rows(gam.statistics, data.frame(
      oSubscale = subst,
      oClass4_renamed = sx,
      GAM.smooth_Fvalue = gam.smooth.F,
      GAM.smooth_RSq = gam.smooth.Rsq,
      GAM.smooth.pvalue = gam.smooth.pvalue,
      smooth.change.onset = change.onset,
      smooth.peak.change = peak.change,
      smooth.decrease.onset = decrease.onset,
      smooth.decrease.offset = decrease.offset,
      smooth.increase.onset = increase.onset,
      smooth.increase.offset = increase.offset,
      smooth.last.change = change.offset,
      max.age.fitted = max.age.fitted,
      max.val.fitted = maxval2
    ))
    
    ## Save fitted values
    gam.fittedvalues <- bind_rows(gam.fittedvalues, data.frame(
      oSubscale = subst, oClass4_renamed = sx,
      visit_age = gam.fittedvalues_temp$visit_age,
      fitted = gam.fittedvalues_temp$.fitted,
      fitted2 = gam.fittedvalues_temp$.fitted2,
      se = gam.fittedvalues_temp$.se,
      lower_ci = gam.fittedvalues_temp$.lower_ci,
      upper_ci = gam.fittedvalues_temp$.upper_ci
    ))
    
    ## Save smooth estimates
    gam.smoothvalues_temp <- gratia::smooth_estimates(gam.model, data = pred, smooth = "s(visit_age)")
    gam.smoothestimates <- bind_rows(gam.smoothestimates, data.frame(
      oSubscale = subst, oClass4_renamed = sx,
      visit_age = gam.smoothvalues_temp$visit_age,
      estimate = gam.smoothvalues_temp$.estimate,
      se = gam.smoothvalues_temp$.se
    ))
    
    ## Save derivatives
    gam.derivatives <- bind_rows(gam.derivatives, data.frame(
      oSubscale = subst, oClass4_renamed = sx,
      visit_age = derv$visit_age,
      derivative = derv$.derivative,
      lower = derv$.lower_ci,
      upper = derv$.upper_ci,
      significant = derv$sig,
      significant_deriv = derv$sig_deriv
    ))
    
    ## Save predictions
    gam.pred_temp <- ggpredict(gam.model, terms=c("visit_age"))
    gam.pred <- bind_rows(gam.pred, data.frame(
      oSubscale = subst, oClass4_renamed = sx,
      visit_age = gam.pred_temp$x,
      predicted = gam.pred_temp$predicted,
      se = gam.pred_temp$std.error,
      lower = gam.pred_temp$conf.low,
      upper = gam.pred_temp$conf.high
    ))
  }
}

# Average derivative per group
deriv_rate <- gam.derivatives %>%
  group_by(oSubscale, oClass4_renamed) %>%
  dplyr::summarise(deriv_rate = mean(derivative, na.rm = TRUE), .groups = "drop")

gam.statistics_UPPS_traj <- left_join(gam.statistics, deriv_rate, by = c("oSubscale","oClass4_renamed"))
gam.fittedvalues_UPPS_traj <- gam.fittedvalues
gam.pred_UPPS_traj <- gam.pred
gam.derivatives_UPPS_traj <- gam.derivatives


custom_order <- c("Mean", "Neg Urg", "Perseverance","Pos Urg", "Premeditation", "Sensation Seeking")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
gam.statistics_UPPS_traj <- gam.statistics_UPPS_traj %>%
  mutate(oSubscale = factor(oSubscale, levels = custom_order),
         oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  arrange(oSubscale, oClass4_renamed)


write.csv(gam.statistics_UPPS_traj, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Smooth_Statistics_Across_UPPSSubscales_TrajectoryGroups.csv', row.names = FALSE)
 
``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}

# Age by UPPS: All Subscsales, no datapoints

age1a <- ggplot(gam.pred_UPPS_traj,
                    aes(x=visit_age, y=predicted, color=oClass4_renamed,fill=oClass4_renamed))+
  geom_line(linewidth = 1) + facet_wrap(~oSubscale, scales = "free")+
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+ 
  # scale_y_continuous(limits = c(1, 4), breaks = seq(1, 4, by = 1))+
labs(x = "\nAge",
       y = "UPPS Score\n")
print(age1a)

age1b <- ggplot(All_UPPS_Mod_Long,
                    aes(x=visit_age, y=Score, color=oClass4_renamed,fill=oClass4_renamed))+
  facet_wrap(~oSubscale, scales = "free")+
  geom_smooth(method="gam", span = .75, formula = y ~ s(x, k = 4, fx = FALSE, bs = "cs"),fullrange = T)+  
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
 scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
  labs(x = "\nAge",
       y = "UPPS Score\n")
print(age1b)

ggsave(age1a, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllUPPSSubscales_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age1b, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllUPPSSubscales_Raw.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


gam.statistics_UPPS_traj$oClass4_renamed2 <- ordered(gam.statistics_UPPS_traj$oClass4_renamed, 
                                                levels = c("Adolescent","Early Increase", "Late Increase",
                                                           "Low"))
      

age1_5 <- gam.statistics_UPPS_traj %>% ungroup () %>% 
  ggplot(aes(x = max.age.fitted, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Peak UPPS (smooth)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(11.75, 12.25), breaks = seq(11.75, 12.25, by = .25))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age1_5)


age2_5 <- gam.statistics_UPPS_traj %>% ungroup () %>% 
  ggplot(aes(x = deriv_rate, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
    labs(x = "\nRate of Decrease",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
  scale_x_continuous(trans = "reverse", limits = c(0, -.03))+ #formatted for mean UPPS
  # scale_x_continuous(trans = "reverse", limits = c(.01, -.04))+ #formatted for consistency across subscales 
    theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age2_5)


age3_5 <- gam.statistics_UPPS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.last.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oSubscale, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
    labs(x = "\nAge of Maturation",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(17, 30), breaks = seq(20, 30, by = 5))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age3_5)


age4_5 <- gam.statistics_UPPS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.peak.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") + facet_wrap(~oSubscale, scales = "free")+
  theme_classic() +
  scale_fill_manual(values = substance_colorbar2) +
      labs(x = "\nAge of Peak Change",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(15, 21), breaks = seq(15, 20, by = 2.5))+#formatted for mean UPPS
     # scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+#formatted for consistency across subscales
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age4_5)

age5_5 <- gam.statistics_UPPS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.decrease.onset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +facet_wrap(~oSubscale, scales = "free")+
  theme_classic() +
  scale_fill_manual(values = substance_colorbar2) +
      labs(x = "\nDecrease Onset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(11.75, 16.2), breaks = seq(12, 16, by = 2))+#formatted for mean UPPS
     # scale_x_continuous(limits = c(12, 20), breaks = seq(15, 20, by = 5))+#formatted for consistency across subscales
theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age5_5)


age6_5 <- gam.statistics_UPPS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.decrease.offset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +facet_wrap(~oSubscale, scales = "free")+
  theme_classic() +
  scale_fill_manual(values = substance_colorbar2) +
      labs(x = "\nDecrease Offset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(19.5, 30), breaks = seq(20, 30, by = 5))+#formatted for mean UPPS
     # scale_x_continuous(limits = c(16, 30), breaks = seq(15, 30, by = 5))+#formatted for consistency across subscales
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age6_5)


ggsave(age1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubscales_Gam_Stats_PeakUPPS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubscales_Gam_Stats_DecreaseRateUPPS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubscales_Gam_Stats_MatureAgeUPPS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age4_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubscales_Gam_Stats_PeakChangeUPPS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 

ggsave(age5_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubscales_Gam_Stats_DecONAgeUPPS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 


ggsave(age6_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllSubscales_Gam_Stats_DecOFFAgeUPPS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 



``` 

## Test for Differences in Start/End Vals and slopes across Trajectory Groups
```{r, echo = FALSE, fig.align='center'}

SU_Vars_Cat_UPPS2$all_gmm_4c_classpast30_Allprob_logp1 <- as.factor(SU_Vars_Cat_UPPS2$all_gmm_4c_classpast30_Allprob_logp1)
SU_Vars_Cat_UPPS2$all_gmm_4c_classpast30_Allprob_logp1 <- revalue(SU_Vars_Cat_UPPS2$all_gmm_4c_classpast30_Allprob_logp1, c("1" = "Low", "2" = "Late Increase", "3" = "Early Increase",
                                    "4" = "Adolescent"))

#1 non-ordered factor 
GMM4_main <- bam(Score ~ 1 + sex  +  income_recode + raceeth_recode + site + 
    s(visit_age, k = 4, fx = F, bs = "cs") + 
      all_gmm_4c_classpast30_Allprob_logp1 + 
    s(visit_age, all_gmm_4c_classpast30_Allprob_logp1, bs = "sz", k = 4, fx = F) +      
      s(subject, bs = "re") + s(subject, visit_age, bs = "re"), #implement random effects, 
    data = SU_Vars_Cat_UPPS2 %>% filter(Subscale == "Mean"), 
    discrete = TRUE,
    method = "fREML")

summary(GMM4_main)
anova(GMM4_main)  
 
  
int_gam.model_plot_main <- ggpredict(GMM4_main, 
                                terms = c("all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot_main)
# 

int_gam.model_plot2 <- ggpredict(GMM4_main, 
                                terms = c("visit_age[all]","all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot2)

#Difference in slopes
mm1 <- hypothesis_test(GMM4_main, 
                terms = c("visit_age[all]", "all_gmm_4c_classpast30_Allprob_logp1"))

mm2 <- hypothesis_test(GMM4_main, 
                terms = c("all_gmm_4c_classpast30_Allprob_logp1", "visit_age[14,25]"))


int_gam.model_plot <- ggpredict(GMM4_main, 
                                terms = c("visit_age[14,25]","all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot)

start_val <- int_gam.model_plot[int_gam.model_plot$x=="14",] %>% 
  group_by(group) %>% 
  dplyr::mutate(pred = predicted,
         type = "start") %>% dplyr::select(group, std.error,
                                                   pred, type, contains("conf"))

end_val <- int_gam.model_plot[int_gam.model_plot$x=="25",] %>% 
  group_by(group) %>% 
  dplyr::mutate(pred = predicted,
         type = "end") %>% dplyr::select(group, std.error,
                                                   pred, type, contains("conf"))

# Calculate slopes
slope_val <- int_gam.model_plot %>%
  group_by(group) %>%
  dplyr::mutate(pred = abs((predicted - lag(predicted)) / (x - lag(x))),
         type = "slope") %>%
         # std_err_slope = std.error(slope)) %>%
  filter(!is.na(pred)) %>%
  dplyr::select(group, pred, type) #,std_err_slope)

print(slope_val)

slope_stats <- rbind(end_val, start_val,slope_val)
slope_stats$Metric <- rep("mean UPPS", nrow(slope_stats))
 

write.csv(slope_stats, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/StartEndSlope_Mean_UPPS_TrajectoryGroups.csv', row.names = FALSE)


``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}

age1a_int <- ggplot(int_gam.model_plot2,
                    aes(x=x, y=predicted, color=group,fill=group))+
  geom_line(linewidth = 1)+
   scale_color_manual(values=substance_colorbar)+
   scale_fill_manual(values=substance_colorbar)+
   theme(aspect.ratio=.5, #legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
labs(x = "\nAge",
       y = "UPPS Score\n")
print(age1a_int)

ggsave(age1a_int, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_MeanUPPS_Predicted_intmod.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


# 
slope_stats$oType <- ordered(slope_stats$type, levels = c("start","slope","end"))

slope_stats$oClass4_renamed <- ordered(slope_stats$group, levels = c("Adolescent","Early Increase","Late Increase","Low"))
slope_stats$oClass4_renamed2 <- ordered(slope_stats$group, levels = c("Low","Late Increase","Early Increase","Adolescent"))


#Connected dots for start, end
p1 <- ggplot(slope_stats %>% filter(oType %in% c("start", "end")),
             aes(x = oType, y = pred, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5, color = "white") +
    geom_line(aes(group = oClass4_renamed),
              alpha=.1, color = "black") + #linewidth slope?
# geom_boxplot(aes(fill = group), alpha = 0.5,outliers = FALSE) +
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
  ylab("\nUPPS Pred") +
  xlab("\nStart/End") +
  theme(aspect.ratio = 1.5,
                     strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1)


ggsave(p1, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_UPPS_Mean_Start_End_Vals.pdf", device = "pdf", dpi = 500) 


matbars_pt5 <- slope_stats %>% filter(type=="slope") %>%
  ggplot(aes(y = oClass4_renamed)) +
  geom_bar(data = slope_stats,# %>% mutate(pred = ifelse(type=="slope",pred, 0)),
           aes(x = pred, fill = oClass4_renamed), stat = "identity",
           position = position_dodge(width = 0.9)) +
    # scale_x_continuous(breaks = c(1, 1.5, 2,2.5), limits = c(1, 30)) +
 coord_cartesian(xlim = c(1.0,2.0))+ #scale_x_continuous(breaks = c(1, 1.5, 2))+
      scale_fill_manual(values = substance_colorbar2) +#scale_x_continuous(trans = "reverse")+
  labs(y = "\nSlope", fill = "Type", color = "Type") +
  theme(aspect.ratio = .5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())#  theme_minimal()
plot(matbars_pt5)
 
ggsave(matbars_pt5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_UPPS_Mean_Slope_Bars.pdf", device = "pdf", dpi = 500) 

``` 

# INHIBITORY CONTROL 
## Test for Differences in Magnitude/Mean/Peak across Trial Types within trajectory groups
```{r, echo = FALSE, fig.align='center'}

SU_Results.AS <- data.frame(
  oCogRewType = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.AS <- data.frame(oCogRewType = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())

# Loop through each level of oSubstance
for (s in unique(SU_Vars_Cat_Anti2$cogRewType)) {
  
  # Subset data for the current substance
  sub_df <- SU_Vars_Cat_Anti2 %>% filter(cogRewType == s)
  # Try fitting the model
  model <- mgcv::gamm(
      corrat ~ s(visit_age, k = 4, fx = FALSE, bs = "cs") + oClass4_renamed + income_recode + 
        raceeth_recode + sex + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model$gam)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Results.AS <- rbind(SU_Results.AS, data.frame(
      oCogRewType = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model$gam,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.AS <- rbind(gam.pred.AS, data.frame(
        oCogRewType = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }

#Peak AS

unique_peak_df <- dplyr::select(All_AS_Mod2, subject, sex, income_recode, raceeth_recode, site, peak_AS, peak_age_AS,cogRewType,oClass4_renamed) 
unique_peak_df <- unique(unique_peak_df)


# Initialize empty results data frame
SU_Peak_Results.AS <- data.frame(
  oCogRewType = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.Peak_AS <- data.frame(oCogRewType = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())

# Loop through each level of oSubstance
for (s in unique(unique_peak_df$cogRewType)) {
  
  # Subset data for the current substance
  sub_df <- unique_peak_df %>% filter(cogRewType == s)
  # Try fitting the model
  model <- mgcv::gam(
      peak_AS ~ oClass4_renamed + sex + income_recode + raceeth_recode + site,
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Peak_Results.AS <- rbind(SU_Peak_Results.AS, data.frame(
      oCogRewType = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.Peak_AS <- rbind(gam.pred.Peak_AS, data.frame(
        oCogRewType = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }


custom_order <- c("main", "rew", "neu")
custom_order2 <- c("Adolescent", "Early Increase", "Late Increase", "Low")

# Convert to factor with levels in custom order
SU_Results.AS <- SU_Results.AS %>%
  mutate(oCogRewType = factor(oCogRewType, levels = custom_order)) %>%
  arrange(oCogRewType)


gam.pred.AS <- gam.pred.AS %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oCogRewType = factor(oCogRewType, levels = custom_order)) %>%
  arrange(oCogRewType, oClass4_renamed)

SU_Peak_Results.AS <- SU_Peak_Results.AS %>%
  mutate(oCogRewType = factor(oCogRewType, levels = custom_order)) %>%
  arrange(oCogRewType)


gam.pred.Peak_AS <- gam.pred.Peak_AS %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oCogRewType = factor(oCogRewType, levels = custom_order)) %>%
  arrange(oCogRewType, oClass4_renamed)

write.csv(SU_Results.AS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Main_Effects_TrajectoryGroup_Across_ASTT.csv', row.names = FALSE)

write.csv(SU_Peak_Results.AS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Main_Effects_TrajectoryGroup_Across_ASTT.csv', row.names = FALSE)


write.csv(gam.pred.AS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Predicted_TrajectoryGroup_Across_ASTT.csv', row.names = FALSE)

write.csv(gam.pred.Peak_AS, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Predicted_TrajectoryGroup_Across_ASTT.csv', row.names = FALSE)

``` 

### Raw Plots: 
```{r, echo = FALSE, fig.align='center'}
 

#Distribution of SU among trajectory groups: Violins 

Traj_Violin_AS <- All_AS_Mod2 %>% filter(!is.na(oClass4_renamed))%>%
  ggplot( aes(y=oClass4_renamed, x=corrat, fill=oClass4_renamed, color=oClass4_renamed)) +facet_wrap(~oCogRewType, scales = "free")+
  scale_color_manual(values=substance_colorbar2)+ 
   scale_fill_manual(values=substance_colorbar2)+ 
    geom_violin(width=1, size=1,adjust = 2) +
      stat_summary(fun = mean, geom = "point", shape = 15, size = 3, color = "black") +   
    theme(aspect.ratio=1.5, legend.position = "none",
                       strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  labs(x = "\nScore",
       y = "Subscale\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))
print(Traj_Violin_AS)

# Distribution of peak ages among trajectory groups: Hists 

peakdens.peak_age_as = dplyr::select(All_AS_Mod2[!is.na(All_AS_Mod2$peak_age_AS),],
                              oClass4_renamed,corrat,peak_age_AS) %>%
                               group_by(oClass4_renamed,cogRewType) %>%
                               summarise(Max_Dense = density(peak_age_AS)$x[which.max(density(peak_age_AS, na.rm=T)$y)])
   
Traj_dense_peak_AS <- All_AS_Mod2 %>%  
  ggplot(aes(x = peak_age_AS, group = oClass4_renamed, colour = oClass4_renamed)) +
  scale_color_manual(values=substance_colorbar2)+facet_wrap(~cogRewType, scales = "free")+
  geom_density(linewidth = 1, bw = .80) + 
   theme(aspect.ratio=1.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
    scale_x_continuous(limits = c(10, 30), breaks = seq(10, 30, by = 10))+
    # geom_vline(data = subscale_summary_upps, aes(xintercept=mean_peak_age_UPPS,color = oClass4_renamed), linetype="dashed") +
   labs(x = "\nAge of Peak Performance",
       y = "Density\n")
plot(Traj_dense_peak_AS)


ggsave(Traj_Violin_AS, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_AS_Violin_AllTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


ggsave(Traj_dense_peak_AS, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_AS_DensePeak_AllTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


subscale_summary_AS_1$oClass4_renamed2<-ordered(subscale_summary_AS_1$oClass4_renamed,
levels=c("Adolescent", "Early Increase", "Late Increase","Low"))

subscale_summary_AS_1 <- subscale_summary_AS_1%>% filter(!is.na(oClass4_renamed2))
p1_5 <- subscale_summary_AS_1 %>% ungroup () %>%  
  ggplot(aes(x = mean_AS, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~cogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
   labs(x = "\nPerformance (% Correct)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(80, 85), breaks = seq(80, 85, by = 1))+ #Formatted for mean AS
      # scale_x_continuous(limits = c(78, 88), breaks = seq(78, 88, by = 2))+ #Formatted for consistency across trial types
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5)


p2_5 <- subscale_summary_AS_1 %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_AS, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~cogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
   labs(x = "\nPeak Performance",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(86, 90), breaks = seq(86, 90, by = 2))+ #Formatted for mean AS
      # scale_x_continuous(limits = c(85, 92), breaks = seq(86, 92, by = 2))+ #Formatted for consistency across subscales
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5)

p3_5 <- subscale_summary_AS_1 %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_age_AS, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~cogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
   labs(x = "\nAge of Peak Performance",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(16.75, 19), breaks = seq(17, 19, by = 1))+
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5)

 
ggsave(p1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_ALLTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_Peak_ALLTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_Peak_Age_ALLTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

p1_5_SE <- ggplot(subscale_summary_AS_1, aes(mean_AS, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_AS-sd_AS, xmax = mean_AS+sd_AS, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
        geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~cogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nPerformance (% Correct)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(80, 86), breaks = seq(80, 86, by = 2))+ #Formatted best for mean UPPS
    # scale_x_continuous(limits = c(80, 88), breaks = seq(80, 88, by = 2))+ #Formatted best for consistency across subscales 
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_SE)
  

p2_5_SE <- ggplot(subscale_summary_AS_1, aes(mean_peak_AS, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_AS-sd_peak_AS, xmax = mean_peak_AS+sd_peak_AS, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
      geom_point(shape = 21, size = 5.5, color = NA) +
    facet_wrap(~cogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
  labs(x = "\nPeak Performance",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(85, 91), breaks = seq(86, 90, by = 2))+ #Formatted best for mean AS
    # scale_x_continuous(limits = c(84, 94), breaks = seq(84, 94, by = 2))+ #Formatted best for consistency across subscales
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_SE)


p3_5_SE <- ggplot(subscale_summary_AS_1, aes(mean_peak_age_AS, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_age_AS-SD_peak_age_AS, xmax = mean_peak_age_AS+SD_peak_age_AS, color = oClass4_renamed2),
    position = position_dodge(0.3))+ 
      geom_point(shape = 21, size = 5.5, color = NA) +
  facet_wrap(~cogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  scale_color_manual(values = substance_colorbar2) +
   labs(x = "\nAge of Peak Performance",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(16.5, 19), breaks = seq(17, 19, by = 1))+ #Formatted best for mean AS
  theme(aspect.ratio = 1.5,
            strip.background = element_blank(),
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5_SE)


ggsave(p1_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_SE_ALLTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_SE_Peak_ALLTrialTypess.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_SE_Peak_Age_ALLTrialTypes.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")



``` 


### Prediction Plots: Predicted Values for Mean AS
```{r, echo = FALSE, fig.align='center'}


p1_5_v <- gam.pred.AS %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oCogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPerformance (% Correct)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(78, 82), breaks = seq(78, 82, by = 2))+#Formatted for Mean AS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_v)

#Pred:
p1_5_v_se <- ggplot(gam.pred.AS, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oCogRewType, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPerformance (% Correct)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(70, 90), breaks = seq(70, 90, by = 10))+#Formatted for Mean AS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p1_5_v_se)

#Predicted Peak values 

p2_5_v <- gam.pred.Peak_AS %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oCogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak Performance (% Correct)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(80, 86), breaks = seq(80, 86, by = 2))+ #Formatted for mean AS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_v)

#Pred:
p2_5_v_se <- ggplot(gam.pred.Peak_AS, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oCogRewType, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak Performance (% Correct)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
      scale_x_continuous(limits = c(76, 92), breaks = seq(76, 92, by = 4))+ #Formatted for mean AS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p2_5_v_se)



ggsave(p1_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_ALLTrialtypes_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_Peak_ALLTrialtypes_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p1_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_SE_ALLTrialTypes_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanAS_SE_Peak_ALLTrialtypes_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


``` 

## Characterize age changes across Trial Types within trajectory groups 
```{r, echo = FALSE, fig.align='center'}


cogRewType <- levels(SU_Vars_Cat_Anti2$oCogRewType)
traj <- levels(SU_Vars_Cat_Anti2$oClass4_renamed)

# Initialize output containers
gam.statistics <- data.frame(
  oCogRewType = factor(),
  oClass4_renamed = factor(),
  GAM.smooth_Fvalue = numeric(),
  GAM.smooth_RSq = numeric(),
  GAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric(),
  max.age.fitted = numeric(),
  max.val.fitted = numeric()
)

gam.fittedvalues <- data.frame(
  oCogRewType = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  fitted = numeric(),
  fitted2 = numeric(),
  se = numeric(),
  lower_ci = numeric(),
  upper_ci = numeric()
)

gam.smoothestimates <- data.frame(
  oCogRewType = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  estimate = numeric(),
  se = numeric()
)

gam.derivatives <- data.frame(
  oCogRewType = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  derivative = numeric(),
  lower = numeric(),
  upper = numeric(),
  significant = numeric(),
  significant_deriv = numeric()
)

gam.pred <- data.frame(
  oCogRewType = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  predicted = numeric(),
  se = numeric(),
  lower = numeric(),
  upper = numeric()
)

# ----------------------------
# Loop over trial types & Trajectory groups
# ----------------------------
for (subst in cogRewType) {
  for (sx in traj) {
    
    sub_df <- SU_Vars_Cat_Anti2 %>%
      filter(oCogRewType == subst, oClass4_renamed == sx)
    
    # if (nrow(sub_df) < 10) next  # skip if too few rows
    
    gam.model <- mgcv::gamm(
      corrat ~ s(visit_age, k = 4, fx = F, bs = "cs"),#+ sex + income_recode + raceeth_recode + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML"
    )
    
    gam.results <- summary(gam.model$gam)
    df <- as.data.frame(unclass(gam.model$gam$model), stringsAsFactors = TRUE)
    
    np <- 200
    pred <- data.frame(visit_age = seq(min(df$visit_age, na.rm = TRUE),
                                       max(df$visit_age, na.rm = TRUE),
                                       length.out = np))
    
    ## Derivatives
    derv <- gratia::derivatives(gam.model, term = "s(visit_age)", 
                                data = pred, interval = "simultaneous", unconditional = FALSE)
    derv <- derv %>% mutate(sig = !(0 > .lower_ci & 0 < .upper_ci),
                            sig_deriv = .derivative * sig)
    
    mean.derivative <- mean(derv$.derivative)
    gam.smooth.F <- gam.results$s.table[1,3]
    gam.smooth.Rsq <- gam.results$r.sq
    if(mean.derivative < 0) gam.smooth.F <- -gam.smooth.F
    gam.smooth.pvalue <- gam.results$s.table[1,4]
    
    ## Temporal characteristics
    change.onset <- ifelse(any(derv$sig), min(derv$visit_age[derv$sig]), NA)
    peak.change <- ifelse(any(derv$sig),
                          mean(derv$visit_age[which.max(abs(derv$sig_deriv))]),
                          NA)
    decrease.onset <- ifelse(any(derv$sig_deriv < 0), min(derv$visit_age[derv$sig_deriv < 0]), NA)
    decrease.offset <- ifelse(any(derv$sig_deriv < 0), max(derv$visit_age[derv$sig_deriv < 0]), NA)
    increase.onset <- ifelse(any(derv$sig_deriv > 0), min(derv$visit_age[derv$sig_deriv > 0]), NA)
    increase.offset <- ifelse(any(derv$sig_deriv > 0), max(derv$visit_age[derv$sig_deriv > 0]), NA)
    change.offset <- ifelse(any(derv$sig), max(derv$visit_age[derv$sig]), NA)
    
    ## Fitted values & maxval2
    gam.fittedvalues_temp <- gratia::fitted_values(gam.model, data = pred)
    gam.fittedvalues_temp$.fitted2 <- plogis(gam.fittedvalues_temp$.fitted) * 30
    
    maxval2 <- max(gam.fittedvalues_temp$.fitted, na.rm = TRUE)
    max.age.fitted <- gam.fittedvalues_temp$visit_age[which.max(gam.fittedvalues_temp$.fitted)]
    
    ## Save stats
    gam.statistics <- bind_rows(gam.statistics, data.frame(
      oCogRewType = subst,
      oClass4_renamed = sx,
      GAM.smooth_Fvalue = gam.smooth.F,
      GAM.smooth_RSq = gam.smooth.Rsq,
      GAM.smooth.pvalue = gam.smooth.pvalue,
      smooth.change.onset = change.onset,
      smooth.peak.change = peak.change,
      smooth.decrease.onset = decrease.onset,
      smooth.decrease.offset = decrease.offset,
      smooth.increase.onset = increase.onset,
      smooth.increase.offset = increase.offset,
      smooth.last.change = change.offset,
      max.age.fitted = max.age.fitted,
      max.val.fitted = maxval2
    ))
    
    ## Save fitted values
    gam.fittedvalues <- bind_rows(gam.fittedvalues, data.frame(
      oCogRewType = subst, oClass4_renamed = sx,
      visit_age = gam.fittedvalues_temp$visit_age,
      fitted = gam.fittedvalues_temp$.fitted,
      fitted2 = gam.fittedvalues_temp$.fitted2,
      se = gam.fittedvalues_temp$.se,
      lower_ci = gam.fittedvalues_temp$.lower_ci,
      upper_ci = gam.fittedvalues_temp$.upper_ci
    ))
    
    ## Save smooth estimates
    gam.smoothvalues_temp <- gratia::smooth_estimates(gam.model, data = pred, smooth = "s(visit_age)")
    gam.smoothestimates <- bind_rows(gam.smoothestimates, data.frame(
      oCogRewType = subst, oClass4_renamed = sx,
      visit_age = gam.smoothvalues_temp$visit_age,
      estimate = gam.smoothvalues_temp$.estimate,
      se = gam.smoothvalues_temp$.se
    ))
    
    ## Save derivatives
    gam.derivatives <- bind_rows(gam.derivatives, data.frame(
      oCogRewType = subst, oClass4_renamed = sx,
      visit_age = derv$visit_age,
      derivative = derv$.derivative,
      lower = derv$.lower_ci,
      upper = derv$.upper_ci,
      significant = derv$sig,
      significant_deriv = derv$sig_deriv
    ))
    
    ## Save predictions
    gam.pred_temp <- ggpredict(gam.model, terms=c("visit_age"))
    gam.pred <- bind_rows(gam.pred, data.frame(
      oCogRewType = subst, oClass4_renamed = sx,
      visit_age = gam.pred_temp$x,
      predicted = gam.pred_temp$predicted,
      se = gam.pred_temp$std.error,
      lower = gam.pred_temp$conf.low,
      upper = gam.pred_temp$conf.high
    ))
  }
}

# Average derivative per group
deriv_rate <- gam.derivatives %>%
  group_by(oCogRewType, oClass4_renamed) %>%
  dplyr::summarise(deriv_rate = mean(derivative, na.rm = TRUE), .groups = "drop")

gam.statistics_AS_traj <- left_join(gam.statistics, deriv_rate, by = c("oCogRewType","oClass4_renamed"))
gam.fittedvalues_AS_traj <- gam.fittedvalues
gam.pred_AS_traj <- gam.pred
gam.derivatives_AS_traj <- gam.derivatives


custom_order <- c("main", "rew", "neu")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
gam.statistics_AS_traj <- gam.statistics_AS_traj %>%
  mutate(oCogRewType = factor(oCogRewType, levels = custom_order),
         oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  arrange(oCogRewType, oClass4_renamed)


write.csv(gam.statistics_AS_traj, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Smooth_Statistics_Across_ASTrialTypes_TrajectoryGroups.csv', row.names = FALSE)
 
``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}

age1a <- ggplot(gam.pred_AS_traj,
                    aes(x=visit_age, y=predicted, color=oClass4_renamed,fill=oClass4_renamed))+
  geom_line(linewidth = 1) + facet_wrap(~oCogRewType, scales = "free")+
  # geom_smooth(method="gam", span = .75, formula = y ~ s(x, k = 4, fx = FALSE, bs = "cs"), fullrange=F)+ #facet_wrap(~Substance, scales = "free")+
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  # scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
  # scale_y_continuous(limits = c(-9, 35), breaks = seq(0, 30, by = 10))+
  labs(x = "\nAge",
       y = "Performance (% Correct)\n")
print(age1a)

age1b <- ggplot(All_AS_Mod2,
                    aes(x=visit_age, y=corrat, color=oClass4_renamed,fill=oClass4_renamed))+
  facet_wrap(~cogRewType, scales = "free")+
  geom_smooth(method="gam", span = .75, formula = y ~ s(x, k = 4, fx = FALSE, bs = "cs"), fullrange=T)+ 
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  # scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
  # scale_y_continuous(limits = c(-9, 35), breaks = seq(0, 30, by = 10))+
 labs(x = "\nAge",
       y = "Performance (% Correct)\n")
print(age1b)

ggsave(age1a, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllASTrialTypes_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age1b, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllASTrialtypes_Raw.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")



gam.statistics_AS_traj$oClass4_renamed2 <- ordered(gam.statistics_AS_traj$oClass4_renamed, 
                                                levels = c("Adolescent","Early Increase", "Late Increase",
                                                           "Low"))
      
age1_5 <- gam.statistics_AS_traj %>% ungroup () %>% 
  ggplot(aes(x = max.age.fitted, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oCogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
  labs(x = "\nAge of Peak Performance (smooth)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(22, 24.25), breaks = seq(22, 24, by = 1))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age1_5)


age2_5 <- gam.statistics_AS_traj %>% ungroup () %>% 
  ggplot(aes(x = deriv_rate, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oCogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
    labs(x = "\nRate of Increase",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(.95, 2.25), breaks = seq(1, 2.25, by = .25))+ #Formatted for mean AS
     # scale_x_continuous(limits = c(.75, 2.25), breaks = seq(.75, 2.25, by = .25))+ #Formatted for consistency across trial types
    theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age2_5)


age3_5 <- gam.statistics_AS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.last.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oCogRewType, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
    labs(x = "\nAge of Maturation",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(17.25, 19.75), breaks = seq(17.5, 19.5, by = 1))+ #Formatted for mean AS
     # scale_x_continuous(limits = c(16, 20), breaks = seq(16,20, by = 1))+ #Formatted for mean AS
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age3_5)


age4_5 <- gam.statistics_AS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.peak.change, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") + facet_wrap(~oCogRewType, scales = "free")+
  theme_classic() +
  scale_fill_manual(values = substance_colorbar2) +
      labs(x = "\nAge of Peak Change",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(14.5, 17), breaks = seq(15, 17, by = 1))+#formatted for mean AS
     # scale_x_continuous(limits = c(14.25, 17), breaks = seq(15, 17, by = 1))+#formatted for consistency across trial types
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age4_5)

age5_5 <- gam.statistics_AS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.increase.onset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +facet_wrap(~oCogRewType, scales = "free")+
  theme_classic() +
  scale_fill_manual(values = substance_colorbar2) +
      labs(x = "\nIncrease Onset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(14.5, 17), breaks = seq(15, 17, by = 1))+#formatted for mean AS
     # scale_x_continuous(limits = c(14, 17), breaks = seq(14, 17, by = 1))+#formatted for consistency across Trial Types
theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age5_5)


age6_5 <- gam.statistics_AS_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.increase.offset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +facet_wrap(~oCogRewType, scales = "free")+
  theme_classic() +
  scale_fill_manual(values = substance_colorbar2) +
      labs(x = "\nIncrease Offset (Age)",
       y = "Trajectory\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase", "Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase", "Low"))+
     scale_x_continuous(limits = c(17.25, 20), breaks = seq(17, 20, by = 1))+#formatted for mean AS
     # scale_x_continuous(limits = c(16, 21), breaks = seq(16, 20, by = 1))+#formatted for consistency across trial types
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(age6_5)


ggsave(age1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_PeakAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_IncreaseRateAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_MatureAgeAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age4_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_PeakChangeAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 

ggsave(age5_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_IncONAgeAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 


ggsave(age6_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_IncOFFAgeAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 



``` 

## Test for Differences in Start/End Vals and slopes across Trajectory Groups
```{r, echo = FALSE, fig.align='center'}

SU_Vars_Cat_Anti2$all_gmm_4c_classpast30_Allprob_logp1 <- as.factor(SU_Vars_Cat_Anti2$all_gmm_4c_classpast30_Allprob_logp1)
SU_Vars_Cat_Anti2$all_gmm_4c_classpast30_Allprob_logp1 <- revalue(SU_Vars_Cat_Anti2$all_gmm_4c_classpast30_Allprob_logp1, c("1" = "Low", "2" = "Late Increase", "3" = "Early Increase",
                                    "4" = "Adolescent"))

#1 non-ordered factor 
GMM4_main <- bam(corrat ~ 1 + sex  +  income_recode + raceeth_recode + site + 
    s(visit_age, k = 4, fx = F, bs = "cs") + 
      all_gmm_4c_classpast30_Allprob_logp1 + 
    s(visit_age, all_gmm_4c_classpast30_Allprob_logp1, bs = "sz", k = 4, fx = F) +      
     s(subject, bs = "re") + s(subject, visit_age, bs = "re"), #implement random effects, 
    data = SU_Vars_Cat_Anti2 %>% filter(cogRewType == "main"), 
    discrete = TRUE,
    method = "fREML")

summary(GMM4_main)
anova(GMM4_main)  
  
# 1low 2 late 3 early 4 adol
int_gam.model_plot_main <- ggpredict(GMM4_main, 
                                terms = c("all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot_main)
# 

int_gam.model_plot2 <- ggpredict(GMM4_main, 
                                terms = c("visit_age[all]","all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot2)

#Difference in slopes
mm1 <- hypothesis_test(GMM4_main, 
                terms = c("visit_age[all]", "all_gmm_4c_classpast30_Allprob_logp1"))

mm2 <- hypothesis_test(GMM4_main, 
                terms = c("all_gmm_4c_classpast30_Allprob_logp1", "visit_age[14,23]"))


int_gam.model_plot <- ggpredict(GMM4_main, 
                                terms = c("visit_age[14,23]","all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot)

start_val <- int_gam.model_plot[int_gam.model_plot$x=="14",] %>% 
  group_by(group) %>% 
  dplyr::mutate(pred = predicted,
         type = "start") %>% dplyr::select(group, std.error,
                                                   pred, type, contains("conf"))

end_val <- int_gam.model_plot[int_gam.model_plot$x=="23",] %>% 
  group_by(group) %>% 
  dplyr::mutate(pred = predicted,
         type = "end") %>% dplyr::select(group, std.error,
                                                   pred, type, contains("conf"))

# Calculate slopes
slope_val <- int_gam.model_plot %>%
  group_by(group) %>%
  dplyr::mutate(pred = abs((predicted - lag(predicted)) / (x - lag(x))),
         type = "slope") %>%
         # std_err_slope = std.error(slope)) %>%
  filter(!is.na(pred)) %>%
  dplyr::select(group, pred, type) #,std_err_slope)

print(slope_val)

slope_stats <- rbind(end_val, start_val,slope_val)
slope_stats$Metric <- rep("Mean AS", nrow(slope_stats))
 

write.csv(slope_stats, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/StartEndSlope_MainAS_TrajectoryGroups.csv', row.names = FALSE)


``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}


age1a_int <- ggplot(int_gam.model_plot2,
                    aes(x=x, y=predicted, color=group,fill=group))+
  geom_line(linewidth = 1)+
   scale_color_manual(values=substance_colorbar)+
   scale_fill_manual(values=substance_colorbar)+
   theme(aspect.ratio=.5, #legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  # scale_y_continuous (trans = "reverse")+
  scale_x_continuous(limits = c(12, 25), breaks = seq(15, 25, by = 5))+
 labs(x = "\nAge",
       y = "Performance (% Correct)\n")
print(age1a_int)

ggsave(age1a_int, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllASMain_Predicted_intmod.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


# 
slope_stats$oType <- ordered(slope_stats$type, levels = c("start","slope","end"))

slope_stats$oClass4_renamed <- ordered(slope_stats$group, levels = c("Adolescent","Early Increase","Late Increase","Low"))
slope_stats$oClass4_renamed2 <- ordered(slope_stats$group, levels = c("Low","Late Increase","Early Increase","Adolescent"))


#Connected dots for start, end
p1 <- ggplot(slope_stats %>% filter(oType %in% c("start", "end")),
             aes(x = oType, y = pred, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5, color = "white") +
    geom_line(aes(group = oClass4_renamed),
              alpha=.1, color = "black") + #linewidth slope?
# geom_boxplot(aes(fill = group), alpha = 0.5,outliers = FALSE) +
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
  ylab("\nAS Pred") +
  xlab("\nStart/End") +
  theme(aspect.ratio = 1.5,
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1)

ggsave(p1, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_AS_Main_Start_End_Vals.pdf", device = "pdf", dpi = 500) 


matbars_pt5 <- slope_stats %>% filter(type=="slope") %>%
  ggplot(aes(y = oClass4_renamed)) +
  geom_bar(data = slope_stats,# %>% mutate(pred = ifelse(type=="slope",pred, 0)),
           aes(x = pred, fill = oClass4_renamed), stat = "identity",
           position = position_dodge(width = 0.9)) +
    # scale_x_continuous(breaks = c(20, 22, 24,26,28,30), limits = c(19, 30)) +
coord_cartesian(xlim = c(50,95))+#+ scale_x_continuous(breaks = c(1, 1.5, 2))+
      scale_fill_manual(values = substance_colorbar2) +#scale_x_continuous(trans = "reverse")+
  labs(y = "\nSlope", fill = "Type", color = "Type") +
  theme(aspect.ratio = .5,
  # legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())#  theme_minimal()
plot(matbars_pt5)
 

ggsave(matbars_pt5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_AS_Main_Slope_Bars.pdf", device = "pdf", dpi = 500) 

``` 

# TISSUE IRON 
## Test for Differences in Magnitude/Mean/Peak across ROIs within trajectory groups
```{r, echo = FALSE, fig.align='center'}



SU_Results.Iron <- data.frame(
  oROI = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.Iron <- data.frame(oROI = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())


# Loop through each level of oSubstance
for (s in unique(SU_Vars_Cat_Iron$roi)) {
  
  # Subset data for the current substance
  sub_df <- SU_Vars_Cat_Iron %>% filter(roi == s)
  # Try fitting the model
  model <- mgcv::gamm(
      tat2.combat ~ s(visit_age, k = 4, fx = FALSE, bs = "cs") + oClass4_renamed + income_recode + 
        raceeth_recode + sex + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model$gam)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Results.Iron <- rbind(SU_Results.Iron, data.frame(
      oROI = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model$gam,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.Iron <- rbind(gam.pred.Iron, data.frame(
        oROI = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }


#Peak Iron

unique_peak_df <- dplyr::select(All_Iron_SU_Mod, subject, sex, income_recode, raceeth_recode, site, peak_Iron, peak_age_Iron,roi,oClass4_renamed) 
unique_peak_df <- unique(unique_peak_df)


# Initialize empty results data frame
SU_Peak_Results.Iron <- data.frame(
  oROI = character(),
  F_value = numeric(),
  p_value = numeric(),
  stringsAsFactors = FALSE
)


gam.pred.Peak_Iron <- data.frame(oROI = factor(), oClass4_renamed = factor(), predicted = numeric(), se = numeric(),
                              lower = numeric(), upper = numeric())


# Loop through each level of oSubstance
for (s in unique(unique_peak_df$roi)) {
  
  # Subset data for the current substance
  sub_df <- unique_peak_df %>% filter(roi == s)
  # Try fitting the model
  model <- mgcv::gam(
      peak_Iron ~ oClass4_renamed + sex + income_recode + raceeth_recode + site,
      data = sub_df,
      method = "REML")
  
  # Run ANOVA on the GAM component
  aov_result <- anova(model)
    F_val <- aov_result$pTerms.table[1,2]
    p_val <- aov_result$pTerms.table[1,3]
    
    # Append to results
    SU_Peak_Results.Iron <- rbind(SU_Peak_Results.Iron, data.frame(
      oROI = s,
      F_value = round(F_val, 2),
      p_value = signif(p_val, 2)
    ))
    
    get_preds <- ggpredict(model,
                                terms = c("oClass4_renamed"))
    predicted <- get_preds$predicted
    se <- get_preds$std.error 
    lower <-  get_preds$conf.low
    upper <- get_preds$conf.high
    x <- get_preds$x 
    
      gam.pred.Peak_Iron <- rbind(gam.pred.Peak_Iron, data.frame(
        oROI = s,
        oClass4_renamed = x, 
        predicted = predicted, 
        se = se,
        lower = lower, 
        upper = upper
      ))
        
  }



custom_order <- c("BG", "Caudate", "NAcc", "Pallidum", "Putamen")
custom_order2 <- c("Adolescent", "Early Increase", "Late Increase", "Low")

# Convert to factor with levels in custom order
SU_Results.Iron <- SU_Results.Iron %>%
  mutate(oROI = factor(oROI, levels = custom_order)) %>%
  arrange(oROI)


gam.pred.Iron <- gam.pred.Iron %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oROI = factor(oROI, levels = custom_order)) %>%
  arrange(oROI, oClass4_renamed)

SU_Peak_Results.Iron <- SU_Peak_Results.Iron %>%
  mutate(oROI = factor(oROI, levels = custom_order)) %>%
  arrange(oROI)

gam.pred.Peak_Iron <- gam.pred.Peak_Iron %>%
  mutate(oClass4_renamed = factor(oClass4_renamed, levels = custom_order2),
         oROI = factor(oROI, levels = custom_order)) %>%
  arrange(oROI, oClass4_renamed)

write.csv(SU_Results.Iron, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Main_Effects_TrajectoryGroup_Across_IronROI.csv', row.names = FALSE)

write.csv(SU_Peak_Results.Iron, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Main_Effects_TrajectoryGroup_Across_IronROI.csv', row.names = FALSE)


write.csv(gam.pred.Iron, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Mean_Predicted_TrajectoryGroup_Across_IronROI.csv', row.names = FALSE)

write.csv(gam.pred.Peak_Iron, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Peak_Predicted_TrajectoryGroup_Across_IronROI.csv', row.names = FALSE)

``` 

### Raw Plots: 
```{r, echo = FALSE, fig.align='center'}
 
#Distribution of SU among trajectory groups: Violins 

Traj_Violin_Iron <- All_Iron_SU_Mod %>%
  ggplot( aes(y=oClass4_renamed, x=tat2.combat, fill=oClass4_renamed, color=oClass4_renamed)) +facet_wrap(~roi, scales = "free")+
  scale_color_manual(values=substance_colorbar2)+ 
   scale_fill_manual(values=substance_colorbar2)+ 
    geom_violin(width=1, size=1,adjust = 2) +
      stat_summary(fun = mean, geom = "point", shape = 15, size = 3, color = "black") +   
    theme(aspect.ratio=1.5, legend.position = "none",
                       strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  labs(x = "\nnT2*w",
       y = "ROI\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))
print(Traj_Violin_Iron)

# Distribution of peak ages among trajectory groups: Hists 


peakdens.peak_age_iron = dplyr::select(All_Iron_SU_Mod[!is.na(All_Iron_SU_Mod$peak_age_Iron),],
                              oClass4_renamed,tat2.combat,peak_age_Iron,roi) %>%
                               group_by(oClass4_renamed,roi) %>%
                               summarise(Max_Dense = density(peak_age_Iron)$x[which.max(density(peak_age_Iron, na.rm=T)$y)])


Traj_dense_peak_Iron <- All_Iron_SU_Mod %>%  
  ggplot(aes(x = peak_age_Iron, group = oClass4_renamed, colour = oClass4_renamed)) +
  scale_color_manual(values=substance_colorbar2)+facet_wrap(~roi, scales = "free")+
  geom_density(linewidth = 1, bw = .80) + 
   theme(aspect.ratio=1.5, legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
    scale_x_continuous(limits = c(10, 30), breaks = seq(10, 30, by = 10))+
    # geom_vline(data = subscale_summary_upps, aes(xintercept=mean_peak_age_UPPS,color = oClass4_renamed), linetype="dashed") +
   labs(x = "\nAge of Peak nT2*w",
       y = "Density\n")
plot(Traj_dense_peak_Iron)


ggsave(Traj_Violin_Iron, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Iron_Violin_AllROIs.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


ggsave(Traj_dense_peak_Iron, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Iron_DensePeak_AllROIs.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


subscale_summary_iron$oClass4_renamed2<-ordered(subscale_summary_iron$oClass4_renamed,
levels=c("Adolescent", "Early Increase", "Late Increase","Low"))

  
p1_5 <- subscale_summary_iron %>% ungroup () %>%  
  ggplot(aes(x = mean_Iron, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~roi, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
        scale_x_continuous(trans = "reverse", limits = c(.0112, .0106), breaks = c(.0112, .0110, .0108, .0106))+ #Formatting for NAcc
  labs(x = "\nnT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5)

  
p2_5 <- subscale_summary_iron %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_Iron, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~roi, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
        scale_x_continuous(trans = "reverse", limits = c(.00965, .00915), breaks = c(.0096, .0094, .0092))+ #Formatting for NAcc
  labs(x = "\nPeak nT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5)


p3_5 <- subscale_summary_iron %>% ungroup () %>%  
  ggplot(aes(x = mean_peak_age_Iron, y = oClass4_renamed2, fill = oClass4_renamed2)) +  
geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~roi, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
          scale_x_continuous(limits = c(18.75, 21), breaks = seq(19, 21, by = 1))+ #Formatted for NAcc
  labs(x = "\nAge of Peak nT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5)



ggsave(p1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Iron_Mean_ALLTrajectories.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Iron_Mean_Peak_ALLTrajectories.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Iron_Mean_Peak_Age_ALLTrajectories.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

  
# 
# ggsave(p1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_ALLSubstances.pdf", device = "pdf", dpi = 500,
#        width = 8, height = 8, units = "in")
# 
# ggsave(p2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_Peak_ALLSubstances.pdf", device = "pdf", dpi = 500,
#        width = 8, height = 8, units = "in")
#  
# ggsave(p3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_Peak_Age_ALLSubstances.pdf", device = "pdf", dpi = 500,
#        width = 8, height = 8, units = "in")


p1_5_SE <- ggplot(subscale_summary_iron, aes(mean_Iron, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_Iron-sd_Iron, xmax = mean_Iron+sd_Iron, color = oClass4_renamed2),
    position = position_dodge(0.3))+facet_wrap(~roi, scales = "free")+
       scale_fill_manual(values=substance_colorbar2)+ 
       scale_color_manual(values=substance_colorbar2)+ 
          scale_x_continuous(trans = "reverse", limits = c(.0113, .0105), breaks = c(.0112, .0110, .0108, .0106))+ #Formatting for NAcc
  labs(x = "\nnT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_SE)


p2_5_SE <- ggplot(subscale_summary_iron, aes(mean_peak_Iron, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_Iron-sd_peak_Iron, xmax = mean_peak_Iron+sd_peak_Iron, color = oClass4_renamed2),
    position = position_dodge(0.3))+facet_wrap(~roi, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+ 
        scale_x_continuous(trans = "reverse", limits = c(.00972, .00910), breaks = c(.0096, .0094, .0092))+ #Formatting for NAcc
  labs(x = "\nPeak nT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_SE)


p3_5_SE <- ggplot(subscale_summary_iron, aes(mean_peak_age_Iron, oClass4_renamed2)) +
  geom_pointrange(
    aes(xmin = mean_peak_age_Iron-SD_peak_age_Iron, xmax = mean_peak_age_Iron+SD_peak_age_Iron, color = oClass4_renamed2),
    position = position_dodge(0.3))+facet_wrap(~roi, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+#coord_flip()+
          scale_x_continuous(limits = c(18.65, 21), breaks = seq(19, 21, by = 1))+ #Formatted for NAcc
  labs(x = "\nAge of Peak nT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5_SE)

ggsave(p1_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Iron_Mean_SE_ALLTrajectories.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Iron_Mean_SE_Peak_ALLTrajectories.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p3_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Iron_Mean_SE_Peak_Age_ALLTrajectories.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


# 
# ggsave(p1_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_ALLSubstances.pdf", device = "pdf", dpi = 500,
#        width = 8, height = 8, units = "in")
# 
# ggsave(p2_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_Peak_ALLSubstances.pdf", device = "pdf", dpi = 500,
#        width = 8, height = 8, units = "in")
#  
# ggsave(p3_5_SE, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Mean_SE_Peak_Age_ALLSubstances.pdf", device = "pdf", dpi = 500,
#        width = 8, height = 8, units = "in")




``` 


### Prediction Plots: Predicted Values for Mean SU
```{r, echo = FALSE, fig.align='center'}


p1_5_v <- gam.pred.Iron %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oROI, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nnT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  # scale_x_continuous(trans = "reverse") +
          scale_x_continuous(trans = "reverse", limits = c(.0128, .0120), breaks = c(.0128, .0124, .0120))+ #Formatting for NAcc
  theme_classic() +
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5_v)

#Pred:
p1_5_v_se <- ggplot(gam.pred.Iron, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oROI, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+#coord_flip()+
    labs(x = "\nnT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  # scale_x_continuous(trans = "reverse") +
            scale_x_continuous(trans = "reverse", limits = c(.0135, .0115), breaks = c(.0135, .0125, .0115))+ #Formatting for NAcc
    theme_classic() +
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p1_5_v_se)


p2_5_v <- gam.pred.Peak_Iron %>% 
  ggplot(aes(x = predicted, y = oClass4_renamed, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oROI, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
labs(x = "\nPeak nT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  # scale_x_continuous(trans = "reverse") +
            scale_x_continuous(trans = "reverse", limits = c(.01142, .0108), breaks = c(.0114, .0112, .0110, .0108))+ #Formatting for NAcc
  theme_classic() +
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5_v)

#Pred:
p2_5_v_se <- ggplot(gam.pred.Peak_Iron, aes(predicted, oClass4_renamed)) +
  geom_pointrange(
    aes(xmin = predicted-se, xmax = predicted+se, color = oClass4_renamed),
    position = position_dodge(0.3))+facet_wrap(~oROI, scales = "free")+
       scale_color_manual(values=substance_colorbar2)+#coord_flip()+
    labs(x = "\nPeak nT2*w",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  # scale_x_continuous(trans = "reverse") +
              scale_x_continuous(trans = "reverse", limits = c(.0120, .010), breaks = c(.0120, .0110, .010))+ #Formatting for NAcc
    theme_classic() +
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
plot(p2_5_v_se)

ggsave(p1_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanIron_ALLROIs_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanIron_Peak_ALLROIs_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")
 
ggsave(p1_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanIron_SE_ALLROIs_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(p2_5_v_se, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_MeanIron_SE_Peak_ALLROIs_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

``` 

## Characterize age changes across ROIs within trajectory groups 
```{r, echo = FALSE, fig.align='center'}

roi <- levels(SU_Vars_Cat_Iron$roi)
traj <- levels(SU_Vars_Cat_Iron$oClass4_renamed)

# Initialize output containers
gam.statistics <- data.frame(
  oROI = factor(),
  oClass4_renamed = factor(),
  GAM.smooth_Fvalue = numeric(),
  GAM.smooth_RSq = numeric(),
  GAM.smooth.pvalue = numeric(),
  smooth.change.onset = numeric(),
  smooth.peak.change = numeric(),
  smooth.decrease.onset = numeric(),
  smooth.decrease.offset = numeric(),
  smooth.increase.onset = numeric(),
  smooth.increase.offset = numeric(),
  smooth.last.change = numeric(),
  max.age.fitted = numeric(),
  max.val.fitted = numeric()
)

gam.fittedvalues <- data.frame(
  oROI = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  fitted = numeric(),
  fitted2 = numeric(),
  se = numeric(),
  lower_ci = numeric(),
  upper_ci = numeric()
)

gam.smoothestimates <- data.frame(
  oROI = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  estimate = numeric(),
  se = numeric()
)

gam.derivatives <- data.frame(
  oROI = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  derivative = numeric(),
  lower = numeric(),
  upper = numeric(),
  significant = numeric(),
  significant_deriv = numeric()
)

gam.pred <- data.frame(
  oROI = factor(),
  oClass4_renamed = factor(),
  visit_age = numeric(),
  predicted = numeric(),
  se = numeric(),
  lower = numeric(),
  upper = numeric()
)

# ----------------------------
# Loop over ROIs & Trajectory groups
# ----------------------------
for (subst in roi) {
  for (sx in traj) {
    
    sub_df <- SU_Vars_Cat_Iron %>%
      filter(roi == subst, oClass4_renamed == sx)
    
    # if (nrow(sub_df) < 10) next  # skip if too few rows
    
    gam.model <- mgcv::gamm(
      tat2.combat ~ s(visit_age, k = 4, fx = F, bs = "cs"),#+ sex + income_recode + raceeth_recode + site,
      random = list(subject = ~1, subject = ~0 + visit_age),
      data = sub_df,
      method = "REML"
    )
    
    gam.results <- summary(gam.model$gam)
    df <- as.data.frame(unclass(gam.model$gam$model), stringsAsFactors = TRUE)
    
    np <- 200
    pred <- data.frame(visit_age = seq(min(df$visit_age, na.rm = TRUE),
                                       max(df$visit_age, na.rm = TRUE),
                                       length.out = np))
    
    ## Derivatives
    derv <- gratia::derivatives(gam.model, term = "s(visit_age)", 
                                data = pred, interval = "simultaneous", unconditional = FALSE)
    derv <- derv %>% mutate(sig = !(0 > .lower_ci & 0 < .upper_ci),
                            sig_deriv = .derivative * sig)
    
    mean.derivative <- mean(derv$.derivative)
    gam.smooth.F <- gam.results$s.table[1,3]
    gam.smooth.Rsq <- gam.results$r.sq
    if(mean.derivative < 0) gam.smooth.F <- -gam.smooth.F
    gam.smooth.pvalue <- gam.results$s.table[1,4]
    
    ## Temporal characteristics
    change.onset <- ifelse(any(derv$sig), min(derv$visit_age[derv$sig]), NA)
    peak.change <- ifelse(any(derv$sig),
                          mean(derv$visit_age[which.max(abs(derv$sig_deriv))]),
                          NA)
    decrease.onset <- ifelse(any(derv$sig_deriv < 0), min(derv$visit_age[derv$sig_deriv < 0]), NA)
    decrease.offset <- ifelse(any(derv$sig_deriv < 0), max(derv$visit_age[derv$sig_deriv < 0]), NA)
    increase.onset <- ifelse(any(derv$sig_deriv > 0), min(derv$visit_age[derv$sig_deriv > 0]), NA)
    increase.offset <- ifelse(any(derv$sig_deriv > 0), max(derv$visit_age[derv$sig_deriv > 0]), NA)
    change.offset <- ifelse(any(derv$sig), max(derv$visit_age[derv$sig]), NA)
    
    ## Fitted values & maxval2
    gam.fittedvalues_temp <- gratia::fitted_values(gam.model, data = pred)
    gam.fittedvalues_temp$.fitted2 <- plogis(gam.fittedvalues_temp$.fitted) * 30
    
    maxval2 <- max(gam.fittedvalues_temp$.fitted, na.rm = TRUE)
    max.age.fitted <- gam.fittedvalues_temp$visit_age[which.max(gam.fittedvalues_temp$.fitted)]
    
    ## Save stats
    gam.statistics <- bind_rows(gam.statistics, data.frame(
      oROI = subst,
      oClass4_renamed = sx,
      GAM.smooth_Fvalue = gam.smooth.F,
      GAM.smooth_RSq = gam.smooth.Rsq,
      GAM.smooth.pvalue = gam.smooth.pvalue,
      smooth.change.onset = change.onset,
      smooth.peak.change = peak.change,
      smooth.decrease.onset = decrease.onset,
      smooth.decrease.offset = decrease.offset,
      smooth.increase.onset = increase.onset,
      smooth.increase.offset = increase.offset,
      smooth.last.change = change.offset,
      max.age.fitted = max.age.fitted,
      max.val.fitted = maxval2
    ))
    
    ## Save fitted values
    gam.fittedvalues <- bind_rows(gam.fittedvalues, data.frame(
      oROI = subst, oClass4_renamed = sx,
      visit_age = gam.fittedvalues_temp$visit_age,
      fitted = gam.fittedvalues_temp$.fitted,
      fitted2 = gam.fittedvalues_temp$.fitted2,
      se = gam.fittedvalues_temp$.se,
      lower_ci = gam.fittedvalues_temp$.lower_ci,
      upper_ci = gam.fittedvalues_temp$.upper_ci
    ))
    
    ## Save smooth estimates
    gam.smoothvalues_temp <- gratia::smooth_estimates(gam.model, data = pred, smooth = "s(visit_age)")
    gam.smoothestimates <- bind_rows(gam.smoothestimates, data.frame(
      oROI = subst, oClass4_renamed = sx,
      visit_age = gam.smoothvalues_temp$visit_age,
      estimate = gam.smoothvalues_temp$.estimate,
      se = gam.smoothvalues_temp$.se
    ))
    
    ## Save derivatives
    gam.derivatives <- bind_rows(gam.derivatives, data.frame(
      oROI = subst, oClass4_renamed = sx,
      visit_age = derv$visit_age,
      derivative = derv$.derivative,
      lower = derv$.lower_ci,
      upper = derv$.upper_ci,
      significant = derv$sig,
      significant_deriv = derv$sig_deriv
    ))
    
    ## Save predictions
    gam.pred_temp <- ggpredict(gam.model, terms=c("visit_age"))
    gam.pred <- bind_rows(gam.pred, data.frame(
      oROI = subst, oClass4_renamed = sx,
      visit_age = gam.pred_temp$x,
      predicted = gam.pred_temp$predicted,
      se = gam.pred_temp$std.error,
      lower = gam.pred_temp$conf.low,
      upper = gam.pred_temp$conf.high
    ))
  }
}

# Average derivative per group
deriv_rate <- gam.derivatives %>%
  group_by(oROI, oClass4_renamed) %>%
  dplyr::summarise(deriv_rate = mean(derivative, na.rm = TRUE), .groups = "drop")

gam.statistics_iron_traj <- left_join(gam.statistics, deriv_rate, by = c("oROI","oClass4_renamed"))
gam.fittedvalues_iron_traj <- gam.fittedvalues
gam.pred_iron_traj <- gam.pred
gam.derivatives_iron_traj <- gam.derivatives


custom_order <- c("BG", "Caudate", "NAcc", "Pallidum", "Putamen")
custom_order2 <- c("Low", "Adolescent", "Early Increase", "Late Increase")
# Convert to factor with levels in custom order
gam.statistics_iron_traj <- gam.statistics_iron_traj %>%
  mutate(oROI = factor(oROI, levels = custom_order),
         oClass4_renamed = factor(oClass4_renamed, levels = custom_order2)) %>%
  arrange(oROI, oClass4_renamed)

write.csv(gam.statistics_iron_traj, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/Smooth_Statistics_Across_IronROIs_TrajectoryGroups.csv', row.names = FALSE)
 
``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}

age1a <- ggplot(gam.pred_iron_traj,
                    aes(x=visit_age, y=predicted, color=oClass4_renamed,fill=oClass4_renamed))+
  geom_line(linewidth = 1) + facet_wrap(~oROI, scales = "free")+
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, #legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  scale_y_continuous (trans = "reverse")+
  # scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
  # scale_y_continuous(limits = c(-9, 35), breaks = seq(0, 30, by = 10))+
labs(x = "\nAge",
       y = "nT2*w\n")
print(age1a)

age1b <- ggplot(All_Iron_SU_Mod,
                    aes(x=visit_age, y=tat2.combat, color=oClass4_renamed,fill=oClass4_renamed))+
  facet_wrap(~roi, scales = "free")+
  geom_smooth(method="gam", span = .75, formula = y ~ s(x, k = 4, fx = FALSE, bs = "cs"), fullrange=T)+ 
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
   theme(aspect.ratio=.5, #legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  scale_y_continuous(trans = "reverse")+
  # scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
  # scale_y_continuous(limits = c(-9, 35), breaks = seq(0, 30, by = 10))+
labs(x = "\nAge",
       y = "nT2*w\n")
  print(age1b)
 

ggsave(age1a, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllIronROIs_Predicted.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age1b, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_AllIronROIs_Raw.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")


gam.statistics_iron_traj$oClass4_renamed2 <- ordered(gam.statistics_iron_traj$oClass4_renamed, 
                                                levels = c("Adolescent","Early Increase", "Late Increase",
                                                           "Low"))
      

p1_5 <- gam.statistics_iron_traj %>% ungroup () %>% 
  ggplot(aes(x = max.age.fitted, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oROI, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
              scale_x_continuous(limits = c(12, 12.2), breaks = seq(12, 12.2, by = .1))+
  labs(x = "\nAge of Peak nT2*w (smooth)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1_5)
     
p2_5 <- gam.statistics_iron_traj %>% ungroup () %>% 
  ggplot(aes(x = deriv_rate, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oROI, scales = "free")+
  scale_fill_manual(values = substance_colorbar2) +
        scale_x_continuous(trans = "reverse", limits = c(-.00006, -.000142), breaks = c(-.00006, -.00010, -.00014))+ #Formatting for NAcc
  labs(x = "\nRate of Increase",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p2_5)

p3_5 <- gam.statistics_iron_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.last.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +
  facet_wrap(~oROI, scales = "free")+
    scale_fill_manual(values = substance_colorbar2) +
              scale_x_continuous(limits = c(15, 30), breaks = seq(15, 30, by = 5))+
  labs(x = "\nAge of Maturation",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p3_5)


p4_5 <- gam.statistics_iron_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.peak.change, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") + facet_wrap(~oROI, scales = "free")+
  theme_classic() +
    scale_fill_manual(values = substance_colorbar2) +
              scale_x_continuous(limits = c(12, 14), breaks = seq(12, 14, by = .5))+ #Formatted for NAcc 
  labs(x = "\nAge of Peak Change",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p4_5)


p5_5 <- gam.statistics_iron_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.decrease.onset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
  geom_point(shape = 21, size = 5.5, color = "white") +facet_wrap(~oROI, scales = "free")+
  theme_classic() +
      scale_fill_manual(values = substance_colorbar2) +
              scale_x_continuous(limits = c(12, 12.20), breaks = seq(12, 12.20, by = .05))+ #Formatted for NAcc
  labs(x = "\nIncrease Onset (Age)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+
theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p5_5)

p6_5 <- gam.statistics_iron_traj %>% ungroup () %>% 
  ggplot(aes(x = smooth.decrease.offset, y = oClass4_renamed2, fill = oClass4_renamed2)) +
geom_point(shape = 21, size = 5.5, color = "white") +facet_wrap(~oROI, scales = "free")+
  theme_classic() +
      scale_fill_manual(values = substance_colorbar2) +
              scale_x_continuous(limits = c(15, 30), breaks = seq(15, 30, by = 5))+ #Formatted for NAcc
  labs(x = "\nIncrease Offset (Age)",
       y = "Trajectory Group\n") +
  scale_y_discrete(
    breaks = c("Adolescent", "Early Increase", "Late Increase","Low"),
    labels = c("Youth Peak", "Adolescent Increase", "Adult Increase","Low"))+  theme(aspect.ratio = 1.5,
  legend.position = "none",
               strip.background = element_blank(),
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p6_5)


ggsave(age1_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllROIs_Gam_Stats_PeakIron.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age2_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllROIs_Gam_Stats_IncreaseRateIron.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age3_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllROIs_Gam_Stats_MatureAgeIron.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

ggsave(age4_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllROIs_Gam_Stats_PeakChangeIron.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 

ggsave(age5_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_ROIs_Gam_Stats_IncONAgeIron.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 


ggsave(age6_5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectory_Age_AllTrialTypes_Gam_Stats_IncOFFAgeAS.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in") 


``` 

## Test for Differences in Start/End Vals and slopes across Trajectory Groups
```{r, echo = FALSE, fig.align='center'}

SU_Vars_Cat_Iron$all_gmm_4c_classpast30_Allprob_logp1 <- as.factor(SU_Vars_Cat_Iron$all_gmm_4c_classpast30_Allprob_logp1)
SU_Vars_Cat_Iron$all_gmm_4c_classpast30_Allprob_logp1 <- revalue(SU_Vars_Cat_Iron$all_gmm_4c_classpast30_Allprob_logp1, c("1" = "Low", "2" = "Late Increase", "3" = "Early Increase",
                                    "4" = "Adolescent"))

#1 non-ordered factor 
GMM4_main <- bam(tat2.combat ~ 1 + sex  +  income_recode + raceeth_recode + site + 
    s(visit_age, k = 4, fx = F, bs = "cs") + 
      all_gmm_4c_classpast30_Allprob_logp1 + 
    s(visit_age, all_gmm_4c_classpast30_Allprob_logp1, bs = "sz", k = 4, fx = F) +      
      s(subject, bs = "re") + s(subject, visit_age, bs = "re"), #implement random effects,
    data = SU_Vars_Cat_Iron %>% filter(roi == "NAcc"), 
    discrete = TRUE,
    method = "fREML")

summary(GMM4_main)
anova(GMM4_main)  
  
# 1low 2 late 3 early 4 adol
int_gam.model_plot_main <- ggpredict(GMM4_main, 
                                terms = c("all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot_main)
# 

int_gam.model_plot2 <- ggpredict(GMM4_main, 
                                terms = c("visit_age[all]","all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot2)

#Difference in slopes
mm1 <- hypothesis_test(GMM4_main, 
                terms = c("visit_age[all]", "all_gmm_4c_classpast30_Allprob_logp1"))

mm2 <- hypothesis_test(GMM4_main, 
                terms = c("all_gmm_4c_classpast30_Allprob_logp1", "visit_age[14,25]"))


int_gam.model_plot <- ggpredict(GMM4_main, 
                                terms = c("visit_age[14,25]","all_gmm_4c_classpast30_Allprob_logp1"))
plot(int_gam.model_plot)

start_val <- int_gam.model_plot[int_gam.model_plot$x=="14",] %>% 
  group_by(group) %>% 
  dplyr::mutate(pred = predicted,
         type = "start") %>% dplyr::select(group, std.error,
                                                   pred, type, contains("conf"))

end_val <- int_gam.model_plot[int_gam.model_plot$x=="25",] %>% 
  group_by(group) %>% 
  dplyr::mutate(pred = predicted,
         type = "end") %>% dplyr::select(group, std.error,
                                                   pred, type, contains("conf"))

# Calculate slopes
slope_val <- int_gam.model_plot %>%
  group_by(group) %>%
  dplyr::mutate(pred = abs((predicted - lag(predicted)) / (x - lag(x))),
         type = "slope") %>%
         # std_err_slope = std.error(slope)) %>%
  filter(!is.na(pred)) %>%
  dplyr::select(group, pred, type) #,std_err_slope)

print(slope_val)

slope_stats <- rbind(end_val, start_val,slope_val)
slope_stats$Metric <- rep("Iron", nrow(slope_stats))
 
 
write.csv(slope_stats, file='/Users/ashparr/Library/Mobile Documents/com~apple~CloudDocs/Documents/Pitt/Manuscripts & Projects/NCANDA Project/DATA/StartEndSlope_NAccIron_TrajectoryGroups.csv', row.names = FALSE)



``` 

### Plots  

```{r, echo = FALSE, fig.align='center'}
#  

age1a_int <- ggplot(int_gam.model_plot2,
                    aes(x=x, y=predicted, color=group,fill=group))+
  geom_line(linewidth = 1)+
   scale_color_manual(values=substance_colorbar)+
   scale_fill_manual(values=substance_colorbar)+
   theme(aspect.ratio=.5, #legend.position = "none",
                      strip.background = element_blank(),
         axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2), 
  axis.ticks = element_line(linewidth = .2),
        panel.grid.major = element_blank(),panel.grid.minor=element_blank(),
        panel.background=element_blank()) +
  scale_y_continuous (trans = "reverse")+
  scale_x_continuous(limits = c(12, 30), breaks = seq(15, 30, by = 5))+
labs(x = "\nAge",
       y = "nT2*w\n")
print(age1a_int)

ggsave(age1a_int, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_Age_NAcc_Predicted_intmod.pdf", device = "pdf", dpi = 500,
       width = 8, height = 8, units = "in")

#Slope plots 
slope_stats$oType <- ordered(slope_stats$type, levels = c("start","slope","end"))

slope_stats$oClass4_renamed <- ordered(slope_stats$group, levels = c("Adolescent","Early Increase","Late Increase","Low"))
slope_stats$oClass4_renamed2 <- ordered(slope_stats$group, levels = c("Low","Late Increase","Early Increase","Adolescent"))


#Connected dots for start, end
p1 <- ggplot(slope_stats %>% filter(oType %in% c("start", "end")),
             aes(x = oType, y = pred, fill = oClass4_renamed)) +
  geom_point(shape = 21, size = 5, color = "white") +
    geom_line(aes(group = oClass4_renamed),
              alpha=.1, color = "black") + #linewidth slope?
# geom_boxplot(aes(fill = group), alpha = 0.5,outliers = FALSE) +
   scale_color_manual(values=substance_colorbar2)+
   scale_fill_manual(values=substance_colorbar2)+
  ylab("\nnT2*w Pred") +
  xlab("\nStart/End") +
  scale_y_continuous(trans="reverse")+
  theme(aspect.ratio = 1.5,
  legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())
print(p1)


ggsave(p1, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_NAcc_Iron_Start_End_Vals.pdf", device = "pdf", dpi = 500) 


matbars_pt5 <- slope_stats %>% filter(type=="slope") %>%
  ggplot(aes(y = oClass4_renamed)) +
  geom_bar(data = slope_stats,# %>% mutate(pred = ifelse(type=="slope",pred, 0)),
           aes(x = pred, fill = oClass4_renamed), stat = "identity",
           position = position_dodge(width = 0.9)) +
    # scale_x_continuous(breaks = c(20, 22, 24,26,28,30), limits = c(19, 30)) +
coord_cartesian(xlim = c(.007,.0125))+ #scale_x_continuous(breaks = c(1, 1.5, 2))+
      scale_fill_manual(values = substance_colorbar2) +#scale_x_continuous(trans = "reverse")+
  labs(y = "\nSlope", fill = "Type", color = "Type") +
  theme(aspect.ratio = .5,
   legend.position = "none",
  axis.text = element_text(size = 8, family = "Arial", color = c("black")),
  axis.title.x = element_text(size = 9, family ="Arial", color = c("black")),
  axis.title.y = element_text(size = 9, family ="Arial", color = c("black")),
  axis.line = element_line(linewidth = .2),
  axis.ticks = element_line(linewidth = .2),
  panel.grid.major = element_blank(),
  panel.grid.minor=element_blank(),
  panel.background=element_blank())#  theme_minimal()
plot(matbars_pt5)
 
ggsave(matbars_pt5, filename = "/Users/ashparr/Documents/Pitt/Manuscripts & Projects/NCANDA Project/Results 2025/Trajectories_NAcc_Iron_Slope_Bars.pdf", device = "pdf", dpi = 500) 


``` 
